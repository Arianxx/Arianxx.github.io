<!DOCTYPE html>
<html lang="zh-cn">
  <head>
    
<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>


<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">



  <meta name="description" content="记录自己的学习与生活"/>













  <link rel="alternate" href="/atom.xml" title="Arian.X">




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=2.6.0" />



<link rel="canonical" href="https://arianx.me/"/>


<link rel="stylesheet" type="text/css" href="/css/style.css?v=2.6.0" />






  
  <script id="baidu_analytics">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?7da15ed69b10673f5e71fb736eca6373";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>



  <script id="google_analytics">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-113448663-1', 'auto');
        ga('send', 'pageview');
  </script>


  <script id="baidu_push">
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>









    <title> Arian.X </title>
  </head>

  <body><div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/." class="logo">Arian.X</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>

<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    
      <a href="/">
        <li class="mobile-menu-item">
          
          
            首页
          
        </li>
      </a>
    
      <a href="/archives/">
        <li class="mobile-menu-item">
          
          
            归档
          
        </li>
      </a>
    
      <a href="/tags">
        <li class="mobile-menu-item">
          
          
            标签
          
        </li>
      </a>
    
      <a href="/about">
        <li class="mobile-menu-item">
          
          
            关于
          
        </li>
      </a>
    
  </ul>
</nav>

    <div class="container" id="mobile-panel">
      <header id="header" class="header"><div class="logo-wrapper">
  <a href="/." class="logo">Arian.X</a>
</div>

<nav class="site-navbar">
  
    <ul id="menu" class="menu">
      
        <li class="menu-item">
          <a class="menu-item-link" href="/">
            
            
              首页
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/archives/">
            
            
              归档
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/tags">
            
            
              标签
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/about">
            
            
              关于
            
          </a>
        </li>
      
    </ul>
  
</nav>

      </header>

      <main id="main" class="main">
        <div class="content-wrapper">
          <div id="content" class="content">
            
  <section id="posts" class="posts">
    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2018/05/31/meta-programming-explore/">内省python元类执行流程</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2018-05-31
        </span>
        
          <div class="post-category">
            
              <a href="/categories/python/">python</a>
            
          </div>
        
        
      </div>
    </header>

    
    

    <div class="post-content">
      
        
        

        
          <h2 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h2><p>上一篇文章里面曾简短提到了在python中使用type类可以实现元编程。实际上，在python，存在几种类型的元编程，包括使用装饰器动态修改类或函数的功能、使用魔术方法重写python内置操作符的行为等，还有使用元类在运行时动态的创建和修改类。本文主要探讨python中使用元类进行元编程时，其中类方法的调用顺序和流程的问题。我想理解了这一点就会对使用元类有更深一点的认知。</p>
<h2 id="什么是元类"><a href="#什么是元类" class="headerlink" title="什么是元类"></a>什么是元类</h2><p>然而，究竟什么是<code>元类</code>？要理解这一点，就需要理解python独特的动态语言特性。在python中，一切都被视为对象。对象的一大特性就是可以在程序运行时，根据不同的上下文而创建。那么，依照这种思想，类也应该是一种对象。把类视为一种对象，在程序运行时，像对象那样动态创建或修改，这种行为就是元编程的一种。能够在程序运行时动态<code>创建或修改类的类</code>就被称为<code>元类</code>。</p>
<p>所有的对象都由某个类构造而来，那么对于元类，因该由哪种类构造而来呢？在python中，这个类就是type。所有的类都是type的实例，这实际上蕴含了一个思想，所有类都可以<code>看作</code>(只是看作)由type类创建而来的。type是一个类，这个类在运行时构造了另外的类。type类是python内置的一个元类。所以，藉继承type类，我们就可以创建出自己的元类。</p>
<p>一个简单的示例：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="class"><span class="keyword">class</span> <span class="title">MetaClass</span><span class="params">(type)</span>:</span></span><br><span class="line"><span class="meta">... </span>    <span class="keyword">pass</span></span><br><span class="line">...</span><br><span class="line"><span class="comment"># 在声明中使用metaclass指定元类，就会用指定的元类来构建类</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="class"><span class="keyword">class</span> <span class="title">SubClass</span><span class="params">(metaclass=MetaClass)</span>:</span></span><br><span class="line"><span class="meta">... </span>    <span class="keyword">pass</span></span><br><span class="line">...</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>SubClass.__class__</span><br><span class="line">&lt;<span class="class"><span class="keyword">class</span> '<span class="title">__main__</span>.<span class="title">MetaClass</span>'&gt;</span></span><br><span class="line"><span class="class">&gt;&gt;&gt; <span class="title">MetaClass</span>.<span class="title">__base__</span></span></span><br><span class="line"><span class="class">&lt;<span class="title">class</span> '<span class="title">type</span>'&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>这个简单的元类示例什么都没有做，但它体现出了python元编程的一些特性。SubClass的<code>__class__</code>属性变为了MetaClass，表明这个类是由MetaClass类，而不是通常的type类所构造的。同时，可以看到我们自定义的元类是type的子类。</p>
<h2 id="一些与元类编程相关的特殊方法"><a href="#一些与元类编程相关的特殊方法" class="headerlink" title="一些与元类编程相关的特殊方法"></a>一些与元类编程相关的特殊方法</h2><p>在了解真正使用元类编程的方法之前，需要预备一些知识——一些与构造类有关的特殊方法。</p>
<h3 id="new-方法"><a href="#new-方法" class="headerlink" title="__new__方法"></a><code>__new__</code>方法</h3><p><code>__new__</code>方法是一个静态方法。当调用类构造一个实例时，这个实例就是由<code>__new__</code>方法产生。<code>__new__</code>方法的第一个参数是调用的类本身。</p>
<h3 id="init-方法："><a href="#init-方法：" class="headerlink" title="__init__方法："></a><code>__init__</code>方法：</h3><p><code>__init__</code>方法修饰将要构造的实例。在返回实例之前做一些初始化工作。</p>
<h3 id="call-方法："><a href="#call-方法：" class="headerlink" title="__call__方法："></a><code>__call__</code>方法：</h3><p>当调用一个实例时，会尝试调用它的构造类（及父类）的<code>__call__</code>方法。</p>
<h2 id="另一个例子"><a href="#另一个例子" class="headerlink" title="另一个例子"></a>另一个例子</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">info = <span class="string">'Success'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SetUp</span><span class="params">(type)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__new__</span><span class="params">(cls, *args, **kwargs)</span>:</span></span><br><span class="line">        <span class="comment"># 调用超类中的__new__方法得到将要产生的子类对象。</span></span><br><span class="line">        sub_cls = super().__new__(cls, *args, **kwargs)</span><br><span class="line">        <span class="keyword">return</span> sub_cls</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, *args, **kwargs)</span>:</span></span><br><span class="line">        <span class="comment"># 根据外部信息修饰子类</span></span><br><span class="line">        self._info = info</span><br><span class="line">        <span class="keyword">return</span> self</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(cls, *args, **kwargs)</span>:</span></span><br><span class="line">        <span class="comment"># 调用子类产生实例，实际上是调用了元类中的__call__方法。这里使用这一点实现单例模式。</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> getattr(cls, <span class="string">'_instance'</span>, <span class="keyword">None</span>):</span><br><span class="line">            cls._instance = cls.__new__(cls)</span><br><span class="line">            cls.__init__(cls._instance, *args, **kwargs)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> cls._instance</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ExcuteClass</span><span class="params">(metaclass=SetUp)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="comment"># 只会被打印一次。</span></span><br><span class="line">        print(<span class="string">'Info is: '</span>, self._info)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">excute1 = ExcuteClass()</span><br><span class="line">excute2 = ExcuteClass()</span><br><span class="line">print(excute1 == excute2)</span><br></pre></td></tr></table></figure>
<p>执行结果为：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Info <span class="keyword">is</span>:  Success</span><br><span class="line"><span class="keyword">True</span></span><br></pre></td></tr></table></figure></p>
<p>这个例子展示了元类的一些动态特性。在这里第一个<code>info = &#39;Success&#39;</code>可以看作随上下文不同而变化的信息，元类SetUp根据这个信息的不同将会创建蕴含不同信息的子类。同时，元类本身通过<code>__call__</code>方法干涉了子类实例的创建，实际上实现了<code>单例模式</code>。在这里，子类只会被初始化一次，只会产生一个实例。</p>
<h2 id="内省执行流程"><a href="#内省执行流程" class="headerlink" title="内省执行流程"></a>内省执行流程</h2><p>那么，使用元类时，详细的顺序究竟是怎么样的呢？先后调用了哪些方法？刚接触元类时，或许许多人都会有这些疑惑。幸亏得益于python强大的动态性，我们可以在运行时方便的内省程序的状况。</p>
<p>可以藉由下面的程序观察到元类的执行流程：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">self_explain</span><span class="params">(ob)</span>:</span></span><br><span class="line">    <span class="comment"># 内省传入的对象</span></span><br><span class="line">    pre_space = <span class="string">' '</span> * <span class="number">3</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 内省类名。只有类才有 __name__ 属性。</span></span><br><span class="line">        print(pre_space, <span class="string">'Class named `&#123;ob.__name__&#125;`.'</span>.format(ob=ob))</span><br><span class="line">    <span class="keyword">except</span> AttributeError:</span><br><span class="line">        print(pre_space, <span class="string">'Have not class name.'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 内省基对象。只有类才有 __obses__ 属性。</span></span><br><span class="line">        print(pre_space, <span class="string">'Inherits from `&#123;&#125;`.'</span>.format(</span><br><span class="line">            [base.__name__ <span class="keyword">for</span> base <span class="keyword">in</span> ob.__bases__]</span><br><span class="line">        ))</span><br><span class="line">    <span class="keyword">except</span> AttributeError:</span><br><span class="line">        print(pre_space, <span class="string">'Have not bases class.'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 类和实例都有 __class__ 属性。</span></span><br><span class="line">        print(pre_space, <span class="string">'Instance of `&#123;ob.__class__&#125;`.'</span>.format(ob=ob))</span><br><span class="line">    <span class="keyword">except</span> AttributeError:</span><br><span class="line">        print(pre_space, <span class="string">'Have not parent class.'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 最后内省对象的 id。相同的对象具有相同的id。</span></span><br><span class="line">    print(pre_space, <span class="string">"My id is &#123;&#125;."</span>.format(id(ob)))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">explain</span><span class="params">(func)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">internal_func</span><span class="params">(*args, **kwargs)</span>:</span></span><br><span class="line">        <span class="comment"># 因为这里用第一个参数的 __class__ 属性来判断其执行在哪个类里。这种方式</span></span><br><span class="line">        <span class="comment"># 默认第一个参数是这个类的实例，然而在 __new__ 方法里，第一个</span></span><br><span class="line">        <span class="comment"># 参数是类本身，其 __class__ 属性是 type，无法反映流程情况。所以如果判断在 __new__ 方法里，</span></span><br><span class="line">        <span class="comment"># 就直接调用 __new__ 将第一个参数（类本身）实例化，访问其 __class__ 属性得到类名。</span></span><br><span class="line">        <span class="comment"># 使用这种方法而不访问 __new__ 里第一个参数的 __name__ 方法的原因是，这样做，</span></span><br><span class="line">        <span class="comment"># 之后就能像对待普通方法一样对待 __new__，内省程序的执行情况。</span></span><br><span class="line">        in_new = func.__name__ == <span class="string">'__new__'</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> in_new:</span><br><span class="line">            self = args[<span class="number">0</span>]</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># 如果在 __new__ 里，调用 __new__ 得到实例。</span></span><br><span class="line">            self = func(*args, **kwargs)</span><br><span class="line"></span><br><span class="line">        print(<span class="string">'In &#123;func.__name__&#125; of &#123;self.__class__&#125;.'</span></span><br><span class="line">              .format(func=func, self=self))</span><br><span class="line">        print(<span class="string">'Inspect first argument:'</span>)</span><br><span class="line">        self_explain(args[<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> in_new:</span><br><span class="line">            <span class="comment"># 如果在 __new__ 方法里，因为之前已经构造过了，直接返回。</span></span><br><span class="line">            return_value = self</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            return_value = func(*args, **kwargs)</span><br><span class="line"></span><br><span class="line">        print(<span class="string">'Inspect return value:'</span>)</span><br><span class="line">        self_explain(return_value)</span><br><span class="line">        print(<span class="string">'_'</span> * <span class="number">32</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> return_value</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> internal_func</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RootClass</span><span class="params">(type)</span>:</span></span><br><span class="line">    <span class="comment"># __new__ 方法是静态方法。</span></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line"><span class="meta">    @explain</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__new__</span><span class="params">(cls, *args, **kwargs)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> super().__new__(cls, *args, **kwargs)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @explain</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, *args, **kwargs)</span>:</span></span><br><span class="line">        super(RootClass, self).__init__(*args, **kwargs)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @explain</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self, *args, **kwargs)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> super(RootClass, self).__call__(*args, **kwargs)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SubClass</span><span class="params">(metaclass=RootClass)</span>:</span></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line"><span class="meta">    @explain</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__new__</span><span class="params">(cls, *args, **kwargs)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> super().__new__(cls, *args, **kwargs)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @explain</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, *args, **kwargs)</span>:</span></span><br><span class="line">        super(SubClass, self).__init__(*args, **kwargs)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @explain</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self, *args, **kwargs)</span>:</span></span><br><span class="line">        print(<span class="string">'You call the SubClass instance.'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    fmt_str = <span class="string">'\n&#123;:_^64&#125;\n'</span></span><br><span class="line"></span><br><span class="line">    print(fmt_str.format(<span class="string">'Start excution'</span>))</span><br><span class="line"></span><br><span class="line">    print(fmt_str.format(<span class="string">'Instantiate the SubClass.'</span>))</span><br><span class="line">    instance = SubClass()</span><br><span class="line"></span><br><span class="line">    print(fmt_str.format(<span class="string">'Invoke the instance.'</span>))</span><br><span class="line">    instance()</span><br></pre></td></tr></table></figure></p>
<p>这段简单的程序主要用一个装饰器来内省了元类与子类中的调用信息与参数、返回值状况。</p>
<p>其执行结果如下：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line">In __new__ of &lt;<span class="class"><span class="keyword">class</span> '<span class="title">__main__</span>.<span class="title">RootClass</span>'&gt;.</span></span><br><span class="line"><span class="class"><span class="title">Inspect</span> <span class="title">first</span> <span class="title">argument</span>:</span></span><br><span class="line">    Class named `RootClass`.</span><br><span class="line">    Inherits <span class="keyword">from</span> `[<span class="string">'type'</span>]`.</span><br><span class="line">    Instance of `&lt;<span class="class"><span class="keyword">class</span> '<span class="title">type</span>'&gt;`.</span></span><br><span class="line"><span class="class">    <span class="title">My</span> <span class="title">id</span> <span class="title">is</span> 2281002834456.</span></span><br><span class="line"><span class="class"><span class="title">Inspect</span> <span class="title">return</span> <span class="title">value</span>:</span></span><br><span class="line">    Class named `SubClass`.</span><br><span class="line">    Inherits <span class="keyword">from</span> `[<span class="string">'object'</span>]`.</span><br><span class="line">    Instance of `&lt;<span class="class"><span class="keyword">class</span> '<span class="title">__main__</span>.<span class="title">RootClass</span>'&gt;`.</span></span><br><span class="line"><span class="class">    <span class="title">My</span> <span class="title">id</span> <span class="title">is</span> 2281002701784.</span></span><br><span class="line"><span class="class"><span class="title">________________________________</span></span></span><br><span class="line"><span class="class"><span class="title">In</span> <span class="title">__init__</span> <span class="title">of</span> &lt;<span class="title">class</span> '<span class="title">__main__</span>.<span class="title">RootClass</span>'&gt;.</span></span><br><span class="line"><span class="class"><span class="title">Inspect</span> <span class="title">first</span> <span class="title">argument</span>:</span></span><br><span class="line">    Class named `SubClass`.</span><br><span class="line">    Inherits <span class="keyword">from</span> `[<span class="string">'object'</span>]`.</span><br><span class="line">    Instance of `&lt;<span class="class"><span class="keyword">class</span> '<span class="title">__main__</span>.<span class="title">RootClass</span>'&gt;`.</span></span><br><span class="line"><span class="class">    <span class="title">My</span> <span class="title">id</span> <span class="title">is</span> 2281002701784.</span></span><br><span class="line"><span class="class"><span class="title">Inspect</span> <span class="title">return</span> <span class="title">value</span>:</span></span><br><span class="line">    Have <span class="keyword">not</span> <span class="class"><span class="keyword">class</span> <span class="title">name</span>.</span></span><br><span class="line"><span class="class">    <span class="title">Have</span> <span class="title">not</span> <span class="title">bases</span> <span class="title">class</span>.</span></span><br><span class="line"><span class="class">    <span class="title">Instance</span> <span class="title">of</span> `&lt;<span class="title">class</span> '<span class="title">NoneType</span>'&gt;`.</span></span><br><span class="line"><span class="class">    <span class="title">My</span> <span class="title">id</span> <span class="title">is</span> 1939641552.</span></span><br><span class="line"><span class="class"><span class="title">________________________________</span></span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"><span class="title">_________________________Start</span> <span class="title">excution_________________________</span></span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"><span class="title">___________________Instantiate</span> <span class="title">the</span> <span class="title">SubClass</span>.<span class="title">____________________</span></span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"><span class="title">In</span> <span class="title">__call__</span> <span class="title">of</span> &lt;<span class="title">class</span> '<span class="title">__main__</span>.<span class="title">RootClass</span>'&gt;.</span></span><br><span class="line"><span class="class"><span class="title">Inspect</span> <span class="title">first</span> <span class="title">argument</span>:</span></span><br><span class="line">    Class named `SubClass`.</span><br><span class="line">    Inherits <span class="keyword">from</span> `[<span class="string">'object'</span>]`.</span><br><span class="line">    Instance of `&lt;<span class="class"><span class="keyword">class</span> '<span class="title">__main__</span>.<span class="title">RootClass</span>'&gt;`.</span></span><br><span class="line"><span class="class">    <span class="title">My</span> <span class="title">id</span> <span class="title">is</span> 2281002701784.</span></span><br><span class="line"><span class="class"><span class="title">In</span> <span class="title">__new__</span> <span class="title">of</span> &lt;<span class="title">class</span> '<span class="title">__main__</span>.<span class="title">SubClass</span>'&gt;.</span></span><br><span class="line"><span class="class"><span class="title">Inspect</span> <span class="title">first</span> <span class="title">argument</span>:</span></span><br><span class="line">    Class named `SubClass`.</span><br><span class="line">    Inherits <span class="keyword">from</span> `[<span class="string">'object'</span>]`.</span><br><span class="line">    Instance of `&lt;<span class="class"><span class="keyword">class</span> '<span class="title">__main__</span>.<span class="title">RootClass</span>'&gt;`.</span></span><br><span class="line"><span class="class">    <span class="title">My</span> <span class="title">id</span> <span class="title">is</span> 2281002701784.</span></span><br><span class="line"><span class="class"><span class="title">Inspect</span> <span class="title">return</span> <span class="title">value</span>:</span></span><br><span class="line">    Have <span class="keyword">not</span> <span class="class"><span class="keyword">class</span> <span class="title">name</span>.</span></span><br><span class="line"><span class="class">    <span class="title">Have</span> <span class="title">not</span> <span class="title">bases</span> <span class="title">class</span>.</span></span><br><span class="line"><span class="class">    <span class="title">Instance</span> <span class="title">of</span> `&lt;<span class="title">class</span> '<span class="title">__main__</span>.<span class="title">SubClass</span>'&gt;`.</span></span><br><span class="line"><span class="class">    <span class="title">My</span> <span class="title">id</span> <span class="title">is</span> 2281036607104.</span></span><br><span class="line"><span class="class"><span class="title">________________________________</span></span></span><br><span class="line"><span class="class"><span class="title">In</span> <span class="title">__init__</span> <span class="title">of</span> &lt;<span class="title">class</span> '<span class="title">__main__</span>.<span class="title">SubClass</span>'&gt;.</span></span><br><span class="line"><span class="class"><span class="title">Inspect</span> <span class="title">first</span> <span class="title">argument</span>:</span></span><br><span class="line">    Have <span class="keyword">not</span> <span class="class"><span class="keyword">class</span> <span class="title">name</span>.</span></span><br><span class="line"><span class="class">    <span class="title">Have</span> <span class="title">not</span> <span class="title">bases</span> <span class="title">class</span>.</span></span><br><span class="line"><span class="class">    <span class="title">Instance</span> <span class="title">of</span> `&lt;<span class="title">class</span> '<span class="title">__main__</span>.<span class="title">SubClass</span>'&gt;`.</span></span><br><span class="line"><span class="class">    <span class="title">My</span> <span class="title">id</span> <span class="title">is</span> 2281036607104.</span></span><br><span class="line"><span class="class"><span class="title">Inspect</span> <span class="title">return</span> <span class="title">value</span>:</span></span><br><span class="line">    Have <span class="keyword">not</span> <span class="class"><span class="keyword">class</span> <span class="title">name</span>.</span></span><br><span class="line"><span class="class">    <span class="title">Have</span> <span class="title">not</span> <span class="title">bases</span> <span class="title">class</span>.</span></span><br><span class="line"><span class="class">    <span class="title">Instance</span> <span class="title">of</span> `&lt;<span class="title">class</span> '<span class="title">NoneType</span>'&gt;`.</span></span><br><span class="line"><span class="class">    <span class="title">My</span> <span class="title">id</span> <span class="title">is</span> 1939641552.</span></span><br><span class="line"><span class="class"><span class="title">________________________________</span></span></span><br><span class="line"><span class="class"><span class="title">Inspect</span> <span class="title">return</span> <span class="title">value</span>:</span></span><br><span class="line">    Have <span class="keyword">not</span> <span class="class"><span class="keyword">class</span> <span class="title">name</span>.</span></span><br><span class="line"><span class="class">    <span class="title">Have</span> <span class="title">not</span> <span class="title">bases</span> <span class="title">class</span>.</span></span><br><span class="line"><span class="class">    <span class="title">Instance</span> <span class="title">of</span> `&lt;<span class="title">class</span> '<span class="title">__main__</span>.<span class="title">SubClass</span>'&gt;`.</span></span><br><span class="line"><span class="class">    <span class="title">My</span> <span class="title">id</span> <span class="title">is</span> 2281036607104.</span></span><br><span class="line"><span class="class"><span class="title">________________________________</span></span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"><span class="title">______________________Invoke</span> <span class="title">the</span> <span class="title">instance</span>.<span class="title">______________________</span></span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"><span class="title">In</span> <span class="title">__call__</span> <span class="title">of</span> &lt;<span class="title">class</span> '<span class="title">__main__</span>.<span class="title">SubClass</span>'&gt;.</span></span><br><span class="line"><span class="class"><span class="title">Inspect</span> <span class="title">first</span> <span class="title">argument</span>:</span></span><br><span class="line">    Have <span class="keyword">not</span> <span class="class"><span class="keyword">class</span> <span class="title">name</span>.</span></span><br><span class="line"><span class="class">    <span class="title">Have</span> <span class="title">not</span> <span class="title">bases</span> <span class="title">class</span>.</span></span><br><span class="line"><span class="class">    <span class="title">Instance</span> <span class="title">of</span> `&lt;<span class="title">class</span> '<span class="title">__main__</span>.<span class="title">SubClass</span>'&gt;`.</span></span><br><span class="line"><span class="class">    <span class="title">My</span> <span class="title">id</span> <span class="title">is</span> 2281036607104.</span></span><br><span class="line"><span class="class"><span class="title">You</span> <span class="title">call</span> <span class="title">the</span> <span class="title">SubClass</span> <span class="title">instance</span>.</span></span><br><span class="line"><span class="class"><span class="title">Inspect</span> <span class="title">return</span> <span class="title">value</span>:</span></span><br><span class="line">    Have <span class="keyword">not</span> <span class="class"><span class="keyword">class</span> <span class="title">name</span>.</span></span><br><span class="line"><span class="class">    <span class="title">Have</span> <span class="title">not</span> <span class="title">bases</span> <span class="title">class</span>.</span></span><br><span class="line"><span class="class">    <span class="title">Instance</span> <span class="title">of</span> `&lt;<span class="title">class</span> '<span class="title">NoneType</span>'&gt;`.</span></span><br><span class="line"><span class="class">    <span class="title">My</span> <span class="title">id</span> <span class="title">is</span> 1939641552.</span></span><br><span class="line"><span class="class"><span class="title">________________________________</span></span></span><br></pre></td></tr></table></figure></p>
<p>可以看出，在程序开始时，执行我们if后的语句前，先自动执行了创建子类的操作。</p>
<p>创建子类首先调用了元类 RootClass 的 <code>__new__</code>方法，其第一个参数是元类本身，然后返回了一个类，其 <code>__name__</code>属性为子类 SubClass，是 RootClass的实例。显然这个类就是我们需要的子类。创建子类后，调用了元类 RootClass的 <code>__init__</code>方法，其第一个参数是我们刚才创建出的子类，然后返回None（不返回值）。</p>
<p>接着，开始执行if后的语句，首先我们实例化了子类。</p>
<p>实例化子类时，首先调用了元类里的<code>__call__</code> 方法，其第一个参数是子类本身。然后，接着调用了子类的 <code>__new__</code> 和 <code>__init__</code> 方法，显然是在 <code>__call__</code> 方法里，使用传入的子类调用的。然后，返回了子类的实例。</p>
<p>最后，调用实例时，调用了子类里的 <code>__call__</code>方法，其第一个参数是实例，不返回值。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>最后，我们可以得出元类时，各方法的实行顺序如下：</p>
<ul>
<li>构建子类：<ul>
<li>元类:<ul>
<li><code>__new__</code>(元类， …)</li>
<li><code>__init__</code>(子类，…)</li>
</ul>
</li>
</ul>
</li>
<li>实例子类：<ul>
<li>元类：<ul>
<li><code>__call__</code>(子类，…)</li>
<li>子类：<ul>
<li><code>__new__</code>(子类，…)</li>
<li><code>__init__</code>(实例，…)</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>调用实例：<ul>
<li>子类：<ul>
<li><code>__call__</code>(实例)</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>最后，实际上，上面的装饰器根据并不知道将要接受什么样的对象，只是在调用了相应的接口，根据参数的不同自动执行了不同的动作。这在无意间利用了python推崇的<code>鸭子类型</code>这一点风格，也就是其它语言的<code>多态</code>。不需要有严格的继承机制，只要关注其实现的接口；不关注其类型本身，而关注其具体的使用方法。</p>

        
      
    </div>

    

    

  </article>

    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2018/05/31/type-and-object-explore/">python中type和object</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2018-05-31
        </span>
        
          <div class="post-category">
            
              <a href="/categories/python/">python</a>
            
          </div>
        
        
      </div>
    </header>

    
    

    <div class="post-content">
      
        
        

        
          <blockquote>
<p>一生一代一双人</p>
</blockquote>
<h2 id="type和object"><a href="#type和object" class="headerlink" title="type和object"></a>type和object</h2><p>python中内置了两个类，type和object，用isinstance和issubclass测试这两个类会发现一些奇怪的特性，如下：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># object是自身的实例</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>isinstance(object, object)</span><br><span class="line"><span class="keyword">True</span></span><br><span class="line"><span class="comment"># object也是type的实例</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>isinstance(object, type)</span><br><span class="line"><span class="keyword">True</span></span><br><span class="line"><span class="comment"># type是自身的实例</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>isinstance(type, type)</span><br><span class="line"><span class="keyword">True</span></span><br><span class="line"><span class="comment"># type是object的实例</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>isinstance(type, object)</span><br><span class="line"><span class="keyword">True</span></span><br><span class="line"><span class="comment"># object是自身的子类</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>issubclass(object, object)</span><br><span class="line"><span class="keyword">True</span></span><br><span class="line"><span class="comment"># object不是type的子类</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>issubclass(object, type)</span><br><span class="line"><span class="keyword">False</span></span><br><span class="line"><span class="comment"># type是自身的子类</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>issubclass(type, type)</span><br><span class="line"><span class="keyword">True</span></span><br><span class="line"><span class="comment"># type也是object的子类</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>issubclass(type, object)</span><br><span class="line"><span class="keyword">True</span></span><br></pre></td></tr></table></figure></p>
<p>可以看到，在这里面，type和object互为实例和子类，只有一个例外。而平时，在我们编写程序的过程中，也时常会注意到我们自己的类会有一些属性指向type和object，如：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="class"><span class="keyword">class</span> <span class="title">Foo</span>:</span></span><br><span class="line"><span class="meta">... </span>    <span class="keyword">pass</span></span><br><span class="line">...</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>Foo.__class__</span><br><span class="line">&lt;<span class="class"><span class="keyword">class</span> '<span class="title">type</span>'&gt;</span></span><br><span class="line"><span class="class">&gt;&gt;&gt; <span class="title">Foo</span>.<span class="title">__base__</span></span></span><br><span class="line"><span class="class">&lt;<span class="title">class</span> '<span class="title">object</span>'&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>那么，type和object这两个类有怎样的区别和联系呢？本文将探讨一些这方面的内容。</p>
<h2 id="继承和实例化"><a href="#继承和实例化" class="headerlink" title="继承和实例化"></a>继承和实例化</h2><p>类的继承和实例化是编程语言的面向对象特性里面重要的两个方面，对于拥有一切皆是对象语言的python，自然也对其有良好的实现。并且得益于python动态语言的性质，我们可以在程序运行时方便的内省对象的各项属性，如上的：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="class"><span class="keyword">class</span> <span class="title">Foo</span>:</span></span><br><span class="line"><span class="meta">... </span>    <span class="keyword">pass</span></span><br><span class="line">...</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="class"><span class="keyword">class</span> <span class="title">Bar</span>:</span></span><br><span class="line"><span class="meta">... </span>    <span class="keyword">pass</span></span><br><span class="line">...</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>f = Foo()</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>f.__class__</span><br><span class="line">&lt;<span class="class"><span class="keyword">class</span> '<span class="title">__main__</span>.<span class="title">Foo</span>'&gt;</span></span><br><span class="line">&gt;&gt;&gt; b = Bar()</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>b.__class__</span><br><span class="line">&lt;<span class="class"><span class="keyword">class</span> '<span class="title">__main__</span>.<span class="title">Bar</span>'&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>可以看到，对象的<code>__class__</code>属性实际上表明了这个对象有哪个类实例化而来。前面说到，在python中，一切皆是对象，类也是一种对象，那么，作为对象的类也拥有<code>__class__</code>属性。而作为对象的类，其<code>__class__</code>属性指向的 type，就表明，这些类是由 type这个元类构建而来。</p>
<p>而<code>__base__</code>属性的特性如下：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="class"><span class="keyword">class</span> <span class="title">Foo</span><span class="params">()</span>:</span></span><br><span class="line"><span class="meta">... </span>    <span class="keyword">pass</span></span><br><span class="line">...</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="class"><span class="keyword">class</span> <span class="title">Bar</span><span class="params">(Foo)</span>:</span></span><br><span class="line"><span class="meta">... </span>    <span class="keyword">pass</span></span><br><span class="line">...</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>Bar.__base__</span><br><span class="line">&lt;<span class="class"><span class="keyword">class</span> '<span class="title">__main__</span>.<span class="title">Foo</span>'&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>可以看到<code>__base__</code>属性实际上指向一个类的父类。如果一个类继承了另一个类，那么这个类的 <code>__base__</code>属性就指向它继承的那个类。（如果是多重继承，这些类就在<code>__bases__</code>属性里面）</p>
<h2 id="作为继承关系顶点的object"><a href="#作为继承关系顶点的object" class="headerlink" title="作为继承关系顶点的object"></a>作为继承关系顶点的object</h2><p>一个类可以继承自其它类，被继承的那个类称为父类。在python中，如果没有显示指定一个类继承自哪个父类，那么这个类就继承自object类。这意味着，在python中，<strong>object实际是所有类的父类，是继承树的根节点，其内蕴含了一些类基本的共有方法。</strong></p>
<p>python还规定，object类没有父类。如：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="class"><span class="keyword">class</span> <span class="title">Foo</span>:</span></span><br><span class="line"><span class="meta">... </span>    <span class="keyword">pass</span></span><br><span class="line">...</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>Foo.__base__</span><br><span class="line">&lt;<span class="class"><span class="keyword">class</span> '<span class="title">object</span>'&gt;</span></span><br><span class="line"><span class="class">&gt;&gt;&gt; <span class="title">issubclass</span><span class="params">(Foo, object)</span></span></span><br><span class="line"><span class="class"><span class="title">True</span></span></span><br><span class="line">&gt;&gt;&gt; f = Foo()</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>isinstance(f, object)</span><br><span class="line"><span class="keyword">True</span></span><br><span class="line"><span class="comment"># object没有父类</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>object.__base__</span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></table></figure></p>
<h2 id="作为对象的顶点的type"><a href="#作为对象的顶点的type" class="headerlink" title="作为对象的顶点的type"></a>作为对象的顶点的type</h2><p>前面说过，在python中，一切皆是对象，类也是对象。是对象就应该有其对应的构造类型。一般的对象由它们的类实例而来。那么作为类本身，它们应该由哪个类实例而来呢？在python中，这个类就是type，<strong>一切的类都是type类型的实例，type的构造类是其自身，type是自身的实例。</strong></p>
<p>因此，type代表了一切实例关系的顶点。可以通过如下的属性观察到：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="class"><span class="keyword">class</span> <span class="title">Foo</span>:</span></span><br><span class="line"><span class="meta">... </span>    <span class="keyword">pass</span></span><br><span class="line">...</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>Foo.__class__</span><br><span class="line">&lt;<span class="class"><span class="keyword">class</span> '<span class="title">type</span>'&gt;</span></span><br></pre></td></tr></table></figure></p>
<h2 id="type与object"><a href="#type与object" class="headerlink" title="type与object"></a>type与object</h2><p>于是，由前面的叙述，可以总结出，object是python里面向对象继承关系的体现，一切的类都是object的子类；type是python里“一切皆是对象”的动态特性的体现，一切的类都是type类型的实例，由type类型构造而来。并且，object类没有父类，type是其自身的实例。</p>
<p>现在，就可以解释开头的奇特特性了：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>isinstance(type, type)</span><br><span class="line"><span class="keyword">True</span></span><br></pre></td></tr></table></figure>
<p>这里体现出type是其自身的实例。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>issubclass(type, object)</span><br><span class="line"><span class="keyword">True</span></span><br></pre></td></tr></table></figure>
<p>这里体现出object是python中一切类的父类，包括type，type也是object的子类。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>isinstance(object, type)</span><br><span class="line"><span class="keyword">True</span></span><br></pre></td></tr></table></figure>
<p>体现出一切类都是type的实例，包括object。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>isinstance(type, object)</span><br><span class="line"><span class="keyword">True</span></span><br></pre></td></tr></table></figure>
<p>type也是object的实例。因为type是自身的实例，而type自身又是object的子类。如果一个对象是某个类的实例，那么这个对象也是那个类<code>__mro__</code>链上（父类）所有类的实例。因此type也是object的实例。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>issubclass(object, object)</span><br><span class="line"><span class="keyword">True</span></span><br></pre></td></tr></table></figure>
<p>虽然object没有父类，但python规定用issubclass判断继承关系时，对自身返回True，因此这里返回True。可以看作，python中一切类也是自身的子类（父类）。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>issubclass(object, type)</span><br><span class="line"><span class="keyword">False</span></span><br></pre></td></tr></table></figure>
<p>object是type的实例，但不是type的子类。object是一切类的父类。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>isinstance(object, object)</span><br><span class="line"><span class="keyword">True</span></span><br></pre></td></tr></table></figure>
<p>object是type的实例，type是object的子类，因此object是自身的实例。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>issubclass(type, type)</span><br><span class="line"><span class="keyword">True</span></span><br></pre></td></tr></table></figure>
<p>一切类都是自身的子类。</p>
<h2 id="元编程"><a href="#元编程" class="headerlink" title="元编程"></a>元编程</h2><p>上面提到，一切类都是type的实例，这体现出python动态语言的特性。实际上，通过type，可以实现<code>元编程</code>，在运行时动态创建、修改类。这个话题就在另一篇文章里再说吧！</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://www.jianshu.com/p/7454c02e86c4" target="_blank" rel="noopener">https://www.jianshu.com/p/7454c02e86c4</a></p>
<p><a href="http://www.cnblogs.com/busui/p/7283137.html" target="_blank" rel="noopener">http://www.cnblogs.com/busui/p/7283137.html</a></p>
<p><a href="https://www.zhihu.com/question/38791962" target="_blank" rel="noopener">https://www.zhihu.com/question/38791962</a></p>

        
      
    </div>

    

    

  </article>

    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2018/05/14/Explore-the-usage-of-super/">浅析python中super用法，兼及继承机制</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2018-05-14
        </span>
        
          <div class="post-category">
            
              <a href="/categories/python/">python</a>
            
          </div>
        
        
      </div>
    </header>

    
    

    <div class="post-content">
      
        
        

        
          <blockquote>
<p>远在天边，我们一无所见，即使近在眼前，也仅仅是连续不断而变幻不定的表象。 </p>
</blockquote>
<h2 id="开始之前"><a href="#开始之前" class="headerlink" title="开始之前"></a>开始之前</h2><p>在学习python的过程中，一直对super的用法感到稍许疑惑。虽然直到它的基本使用方法，却一直觉得模模糊糊。本文将根据实例简要探讨python3中super函数的行为，以加强对super函数的认知，兼及一些相关方面的内容。</p>
<p>本文将简要谈谈我对对象和继承机制的理解，最终探讨super的用法。</p>
<h2 id="Ⅰ-面向对象机制"><a href="#Ⅰ-面向对象机制" class="headerlink" title="Ⅰ.面向对象机制"></a>Ⅰ.面向对象机制</h2><p><code>面向对象(OOP, Object Oriented Programming）</code>是目前编程语言中一种主流的思想，python从设计初期就已经是一门面向对象的语言。python为面向对象编程提供了强大的语法支持。因此，在python中，使用面向对象的方式进行程序设计是十分自然并且容易的。</p>
<p>理所当然，一旦提到面向对象的编程思想，那么便会自然而然想到面向对象思想中的一些重要概念。比如说：<code>类（Class)</code>。类是一种数据结构，简单来说，可以理解为对某些拥有共同属性，或行为的对象的抽象。它可以视作这些拥有相同属性或行为的对象的蓝图，封装了这些对象的共同属性或行为，使得程序设计更模块化，提高了代码的可复用性——一个<code>对象（Object）</code>是它的类的实例，它能够访问它的构造类中的所有属性或方法。</p>
<p>可以将python中的类与对象类比到现实中。这样，对象就是现实世界中的客体，是一种具体的实体。现实世界中的所有事物都可以看作一个对象。例如，一个人。当我们谈到这个对象时，我们所想到的，是这个带有数量词的、具体的、实在的个体，是“这个人”而不是“那个人”。而现实世界里面存在许许多多的人。这些所有的人有某些共同的特征，我们将这些特征聚合起来，所形成的一个抽象的、宽泛的“人”的这个形式，就是所有作为人的对象的类。</p>
<p>每个具体的对象都有其独特的<code>标识</code>。例如，在现实中，每个人都会有一个名字。一般来说，在某个给定范围的命名空间中，这个标识是唯一的。我们可以说，某个具有独特标识符的对象属于什么类。例如，张三是人，就是说”张三”属于”人”这个类。这样，可以发现，一般情况下，凡是可以说成“某个东西是什么”这种句法的，都可以抽象出类与对象的关系。</p>
<p>类比到现实中，类与对象是一种所属关系，对象是一种客观存在的实体。而放到具体的程序设计中来说，类可以视作对某些具有共同特征或行为的数据的<code>抽象</code>。</p>
<h2 id="Ⅱ-类的继承机制"><a href="#Ⅱ-类的继承机制" class="headerlink" title="Ⅱ.类的继承机制"></a>Ⅱ.类的继承机制</h2><p>一个对象可以说成是某个类的实例，一般情况，就可以说成”对象是类”这种形式。然而，在许多情况下，在这样抽象之后，我们仍然可以发现，类也有其自身的所属。例如说，泰迪是一只熊，在这里，”泰迪”是具体的对象，”熊”是”泰迪”的类，而“熊”这个类，又由“哺乳动物”这个类细分而来。我们可以这样说，熊继承自哺乳动物，而泰迪既是一只熊，也是一只哺乳动物。这样，父类就可以理解为对类的基本属性的抽象，子类是对于父类的补充。</p>
<p><img src="http://arian-blogs.oss-cn-beijing.aliyuncs.com/18-5-15/85242660.jpg" alt="补充"></p>
<p>简单来说，对象之于类，是“某个东西是什么”，而子类之于父类，是子类补充了父类。</p>
<p>在python中，如果一个子类继承了父类，就称这个父类为子类的<code>base class</code>，并且，这个子类的所有base class，都可以在<code>__bases__</code>属性中访问。这个子类的实例，也可以同时访问子类所有父类、以及后续的父类内的属性或方法（此处不考虑带前置双下划线的私有方法）。</p>
<p>如：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="class"><span class="keyword">class</span> <span class="title">Animal</span><span class="params">()</span>:</span></span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">kind</span><span class="params">(self)</span>:</span></span><br><span class="line"><span class="meta">... </span>        print(<span class="string">"I'm an animal."</span>)</span><br><span class="line">...</span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="class"><span class="keyword">class</span> <span class="title">Bird</span><span class="params">(Animal)</span>:</span></span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">skill</span><span class="params">(self)</span>:</span></span><br><span class="line"><span class="meta">... </span>        print(<span class="string">"I can fly."</span>)</span><br><span class="line">...</span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>bird = Bird()</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>bird.skill()</span><br><span class="line">I can fly.</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>bird.kind()</span><br><span class="line">I<span class="string">'m an animal.</span></span><br></pre></td></tr></table></figure></p>
<p>可见，实例可访问它的构造类以及之后的父类中的方法。</p>
<p>同时，子类可以<code>覆盖</code>父类的方法。这样，访问实例中的这个方法时，就访问它的构造方法内重写的那个方法，而不向后追溯。</p>
<p>如：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="class"><span class="keyword">class</span> <span class="title">Animal</span><span class="params">()</span>:</span></span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">kind</span><span class="params">(self)</span>:</span></span><br><span class="line"><span class="meta">... </span>        print(<span class="string">"I'm an animal."</span>)</span><br><span class="line">...</span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="class"><span class="keyword">class</span> <span class="title">Bird</span><span class="params">(Animal)</span>:</span></span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">kind</span><span class="params">(self)</span>:</span></span><br><span class="line"><span class="meta">... </span>        print(<span class="string">"I'm a bird."</span>)</span><br><span class="line">...</span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>bird = Bird()</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>bird.kind()</span><br><span class="line">I<span class="string">'m a bird.</span></span><br></pre></td></tr></table></figure></p>
<p>python还支持<code>多重继承</code>。一个子类，可以同时拥有多个父类，同时继承这些父类的属性或方法。可以通过访问子类的<code>__bases__</code>属性获得它的父类：<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="class"><span class="keyword">class</span> <span class="title">Food</span><span class="params">()</span>:</span></span><br><span class="line"><span class="meta">... </span>    eatable = <span class="keyword">True</span></span><br><span class="line">...</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="class"><span class="keyword">class</span> <span class="title">Ice</span><span class="params">()</span>:</span></span><br><span class="line"><span class="meta">... </span>    cold = <span class="keyword">True</span></span><br><span class="line">...</span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="class"><span class="keyword">class</span> <span class="title">IceCream</span><span class="params">(Food, Ice)</span>:</span></span><br><span class="line"><span class="meta">... </span>    <span class="keyword">pass</span></span><br><span class="line">...</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>IceCream.__bases__</span><br><span class="line">(&lt;class '__main__.Food'&gt;, &lt;class '__main__.Ice'&gt;)</span><br></pre></td></tr></table></figure></p>
<p>实例可以访问这些父类的方法：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>IceCream.eatable</span><br><span class="line"><span class="keyword">True</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>IceCream.cold</span><br><span class="line"><span class="keyword">True</span></span><br></pre></td></tr></table></figure></p>
<p>但是，思考一下，如果子类继承了多个父类，同时这些父类拥有某些相同的属性或方法，实例该访问哪个方法呢？</p>
<p>这个问题的解决方案，就是依赖于特定的Method Resolution Order (MRO)。</p>
<h2 id="Ⅲ-MRO"><a href="#Ⅲ-MRO" class="headerlink" title="Ⅲ.MRO"></a>Ⅲ.MRO</h2><p>python利用MRO来决定多重继承中属性或方法的搜索顺序。如果一个类不止具有一个基类，那么，可以访问这个类的<code>__mro__</code>属性以获取其MRO链。在python3中，<a href="https://en.wikipedia.org/wiki/C3_linearization" target="_blank" rel="noopener">C3算法</a>是唯一支持的MRO算法。</p>
<p>一般将C3算法理解为类似于广度优先搜索，但实际上它又与广度优先搜索有一定差别。</p>
<p>考虑下面的继承关系：</p>
<p><img src="http://arian-blogs.oss-cn-beijing.aliyuncs.com/18-5-15/7957065.jpg" alt="继承"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="class"><span class="keyword">class</span> <span class="title">A</span><span class="params">()</span>:</span></span><br><span class="line"><span class="meta">... </span>    id = <span class="number">1</span></span><br><span class="line">...</span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="class"><span class="keyword">class</span> <span class="title">B</span><span class="params">(A)</span>:</span></span><br><span class="line"><span class="meta">... </span>    id = <span class="number">2</span></span><br><span class="line">...</span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="class"><span class="keyword">class</span> <span class="title">C</span><span class="params">(A)</span>:</span></span><br><span class="line"><span class="meta">... </span>    id = <span class="number">3</span></span><br><span class="line">...</span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="class"><span class="keyword">class</span> <span class="title">D</span><span class="params">(B)</span>:</span></span><br><span class="line"><span class="meta">... </span>    <span class="keyword">pass</span></span><br><span class="line">...</span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="class"><span class="keyword">class</span> <span class="title">E</span><span class="params">(C)</span>:</span></span><br><span class="line"><span class="meta">... </span>    <span class="keyword">pass</span></span><br><span class="line">...</span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="class"><span class="keyword">class</span> <span class="title">F</span><span class="params">(D, E)</span>:</span></span><br><span class="line"><span class="meta">... </span>    <span class="keyword">pass</span></span><br><span class="line">...</span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></table></figure>
<p>在这里，类F同时继承了类D和类E，而类D、E又分别继承了B、C，最终继承自类A。如果实例化一个类F，查看其id属性，最终结果会是哪一个？</p>
<p>实际为：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>f=F()</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>f.id</span><br><span class="line"><span class="number">2</span></span><br></pre></td></tr></table></figure></p>
<p>可以观察到，实际上访问了类B中的属性。</p>
<p>可以如前所述的访问类F的<code>__mro__</code>属性查看其MRO链：<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>F.__mro__</span><br><span class="line">(&lt;class '__main__.F'&gt;, &lt;class '__main__.D'&gt;, &lt;class '__main__.B'&gt;, &lt;class '__main__.E'&gt;, &lt;class '__main__.C'&gt;, &lt;class '__main__.A'&gt;, &lt;class 'object'&gt;)</span><br></pre></td></tr></table></figure></p>
<p>访问顺序为：F &gt; D &gt; B &gt; E &gt; C &gt; A。可以看到C3算法与广度优先算法的区别。按照广度优先算法，应该是F &gt; D &gt; E &gt; B &gt; C &gt; A。然而这里先深度优先搜索到了与其它支链有交点的节点，然后返回去进行广度优先搜索。</p>
<p>实际上，在python3中的MRO算法为：对于一个有多重父类的子类，它的MRO链为其自身与其父类的merge()线性操作的结果。用表达式表示为：<code>L[C(B1...BN)] = C + merge(L(B1)+..L(BN)+B1+...BN)</code></p>
<p>其中，merge的规则为：</p>
<ol>
<li>递归展开其内的L为MRO列表。</li>
<li>取第一个列表中的第一个元素，如果这个元素不出现之后列表，或者不是其它列表除首元素之外的元素，就将它提取到merge外面，作为最终MRO链的一员，同时消去merge中的这个元素。</li>
<li>重复第二步直到遇到不可提取的元素，对下一个列表重复第二步。直到不存在元素，MRO链构建完成。</li>
<li>否则，这个继承不合法。</li>
</ol>
<p>例如，对于例子而言，其求MRO链的过程就是：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">L(F(D, E)) = F + merge(L(D) + L(E) + D + E)</span><br><span class="line">           = F + merge([D, B, A] + [E, C, A] + D +E)</span><br><span class="line">           = F + D + merge([B, A] + [E, C, A] +E)</span><br><span class="line">           = F + D + B + merge(A + [E, C, A] + E)</span><br><span class="line">           = F + D + B + E + merge(A + [C, A])</span><br><span class="line">           = F + D + B + E + C + merge(A)</span><br><span class="line">           = F + D + B + E + C + A</span><br></pre></td></tr></table></figure></p>
<p>与由<code>__mro__</code>属性看到的MRO链一致。</p>
<p>那么，到现在为止，我们已经知道如何继承，如何多重继承，以及在多重继承中访问特性，python搜索的机制。同时，我们已经可以覆盖父类中的属性或方法。那么，还剩下最后一点，python继承方面的机制就完善了。那就是，如果我们继承父类后，又覆盖了父类中的特性，我们该如何才能访问到父类中的那个特性呢？</p>
<p>如果覆盖了方法，最直观的调用父类中方法的方式，是直接在那个方法中通过父类来调用方法，然后传入自身的实例。就像这样：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="class"><span class="keyword">class</span> <span class="title">Food</span><span class="params">()</span>:</span></span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">say</span><span class="params">(self)</span>:</span></span><br><span class="line"><span class="meta">... </span>        print(<span class="string">"I'm a food."</span>)</span><br><span class="line">...</span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="class"><span class="keyword">class</span> <span class="title">IceCream</span><span class="params">(Food)</span>:</span></span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">say</span><span class="params">(self)</span>:</span></span><br><span class="line"><span class="meta">... </span>        Food.say(self)</span><br><span class="line"><span class="meta">... </span>        print(<span class="string">"And I'm a ice cream."</span>)</span><br><span class="line">...</span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>ice_cream = IceCream()</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>ice_cream.say()</span><br><span class="line">I<span class="string">'m a food.</span></span><br><span class="line"><span class="string">And I'</span>m a ice cream.</span><br></pre></td></tr></table></figure></p>
<p>然而通过这种方式所产生的一个问题是，在如下这种情况下，通过这种方式所产生的调用会出现重复调用：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="class"><span class="keyword">class</span> <span class="title">Food</span><span class="params">()</span>:</span></span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">say</span><span class="params">(self)</span>:</span></span><br><span class="line"><span class="meta">... </span>        print(<span class="string">"I'm Food."</span>)</span><br><span class="line">...</span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="class"><span class="keyword">class</span> <span class="title">Water</span><span class="params">(Food)</span>:</span></span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">say</span><span class="params">(self)</span>:</span></span><br><span class="line"><span class="meta">... </span>        Food.say(self)</span><br><span class="line"><span class="meta">... </span>        print(<span class="string">"I'm Water."</span>)</span><br><span class="line">...</span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="class"><span class="keyword">class</span> <span class="title">Ice</span><span class="params">(Food)</span>:</span></span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">say</span><span class="params">(self)</span>:</span></span><br><span class="line"><span class="meta">... </span>        Food.say(self)</span><br><span class="line"><span class="meta">... </span>        print(<span class="string">"I'm Ice."</span>)</span><br><span class="line">...</span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="class"><span class="keyword">class</span> <span class="title">IceCream</span><span class="params">(Water, Ice)</span>:</span></span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">say</span><span class="params">(self)</span>:</span></span><br><span class="line"><span class="meta">... </span>        Water.say(self)</span><br><span class="line"><span class="meta">... </span>        Ice.say(self)</span><br><span class="line">...</span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>ice_cream = IceCream()</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>ice_cream.say()</span><br><span class="line">I<span class="string">'m Food.</span></span><br><span class="line"><span class="string">I'</span>m Water.</span><br><span class="line">I<span class="string">'m a food.</span></span><br><span class="line"><span class="string">I'</span>m Ice.</span><br></pre></td></tr></table></figure></p>
<p>这样，Food中的say方法被无意间调用了两次。</p>
<p>解决这个办法，使得在继承关系中，能够正确调用父类方法的工具，就是使用python中的super对象。</p>
<h2 id="Ⅳ-super对象"><a href="#Ⅳ-super对象" class="headerlink" title="Ⅳ.super对象"></a>Ⅳ.super对象</h2><p>在python中，super对象用于构造访问给定子类的MRO链上，父类特性的代理。它接受两个参数，第一参数是要构造代理的对象，第二个参数是要绑定给父类参数的对象。它可以这样用：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="class"><span class="keyword">class</span> <span class="title">Food</span><span class="params">()</span>:</span></span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">say</span><span class="params">(self)</span>:</span></span><br><span class="line"><span class="meta">... </span>        print(<span class="string">"I'm Food."</span>)</span><br><span class="line">...</span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="class"><span class="keyword">class</span> <span class="title">Water</span><span class="params">(Food)</span>:</span></span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">say</span><span class="params">(self)</span>:</span></span><br><span class="line"><span class="meta">... </span>        super().say()</span><br><span class="line"><span class="meta">... </span>        print(<span class="string">"I'm Water."</span>)</span><br><span class="line">...</span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="class"><span class="keyword">class</span> <span class="title">Ice</span><span class="params">(Food)</span>:</span></span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">say</span><span class="params">(self)</span>:</span></span><br><span class="line"><span class="meta">... </span>        super().say()</span><br><span class="line"><span class="meta">... </span>        print(<span class="string">"I'm Ice."</span>)</span><br><span class="line">...</span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="class"><span class="keyword">class</span> <span class="title">IceCream</span><span class="params">(Water, Ice)</span>:</span></span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">say</span><span class="params">(self)</span>:</span></span><br><span class="line"><span class="meta">... </span>        super().say()</span><br><span class="line">...</span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>ice_cream = IceCream()</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>ice_cream.say()</span><br><span class="line">I<span class="string">'m Food.</span></span><br><span class="line"><span class="string">I'</span>m Ice.</span><br><span class="line">I<span class="string">'m Water.</span></span><br></pre></td></tr></table></figure></p>
<p>可见，它给出了理想的结果，最高的父类Food仅被访问了一次，同时两个中间的父类都访问了一次。</p>
<p><strong>事实上，super搜寻特性的机制与使用getattr访问这个子类的机制相同（即，使用点运算符访问特性），都是根据<code>__mro__</code>属性中给出的链进行搜寻。经过super代理的访问，会转发给MRO链上的下一个类</strong>。如果最终super没有在链上的对象里找到想要访问的方法，最后又没有在super对象上自身找到，就会弹出AttributeError错误。</p>
<p>super不是一个函数，而是一个对象，返回一个代理对象。通过这个代理对象访问的所有方法或属性，都会沿给定类的MRO链查找。需要注意的是，<strong>如果父类中存在与super对象自身相同的特性，那个特性就会覆盖super本身的特性。</strong>如：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="class"><span class="keyword">class</span> <span class="title">Food</span><span class="params">()</span>:</span></span><br><span class="line"><span class="meta">... </span>    <span class="keyword">pass</span></span><br><span class="line">...</span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>food = Food()</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>print(super(Food, food).__str__())</span><br><span class="line">&lt;__main__.Food object at <span class="number">0x0000020FE57D6C50</span>&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>print(getattr(super, <span class="string">'__str__'</span>)(super))</span><br><span class="line">&lt;<span class="class"><span class="keyword">class</span> '<span class="title">super</span>'&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>可见，通过点运算符访问的，被转发给了代理类的父类。通过getattr函数则可以得到正确的结果。</p>
<p>super的第一个参数是指定要在其上MRO链搜寻特性的类，第二个参数会被绑定给将要调用的方法。第二个参数允许两种类型：</p>
<ol>
<li>如果第二个参数是对象，那么这个对象必须是第一个参数的实例。也就是isinstance(arg1, arg2)返回True。</li>
<li>如果第二个参数是类（类型对象），那么这个类必需是第一个参数的子类。也就是issubclass(arg1, arg2)返回True。</li>
</ol>
<p>对于第一种情况，如果将要调用的是普通方法，这个对象会被绑定为其第一个参数；第二种情况，如果将要调用的是类方法，这个类将会被绑定为第二个参数。除此之外，不作绑定。如：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="class"><span class="keyword">class</span> <span class="title">Food</span><span class="params">()</span>:</span></span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">normal</span><span class="params">(self)</span>:</span></span><br><span class="line"><span class="meta">... </span>        print(<span class="string">'normal'</span>)</span><br><span class="line"><span class="meta">... </span>    @classmethod</span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">cls</span><span class="params">(cls)</span>:</span></span><br><span class="line"><span class="meta">... </span>        print(<span class="string">'cls'</span>)</span><br><span class="line"><span class="meta">... </span>    @staticmethod</span><br><span class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">static</span><span class="params">()</span>:</span></span><br><span class="line"><span class="meta">... </span>        print(<span class="string">'static'</span>)</span><br><span class="line">...</span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="class"><span class="keyword">class</span> <span class="title">Ice</span><span class="params">(Food)</span>:</span></span><br><span class="line"><span class="meta">... </span>    <span class="keyword">pass</span></span><br><span class="line">...</span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>ice = Ice()</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>super(Ice, ice).normal()  <span class="comment"># 第二个参数是实例</span></span><br><span class="line">normal</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>super(Ice, Ice).cls()  <span class="comment"># 第二个参数是类</span></span><br><span class="line">cls</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>super(Ice, ice).static()</span><br><span class="line">static</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>super(Ice, Ice).static()</span><br><span class="line">static</span><br></pre></td></tr></table></figure></p>
<p>在一般情况下，我们看到的调用super的方式直接是super()，而没有传递任何参数，这是针么回事？实际上，调用super()就等同于调用了super(type(self), self)，这种省略形式只能在类的方法中调用。</p>
<p>最后，有趣的一点是，在途中我打算查看super对象的源码时，通过pycharm，却只看到了带有“real signature unknown”注释的pass实现。这说明python是在c语言层面实现super对象的。</p>
<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><p><a href="https://www.jianshu.com/p/45619cf50aa7" target="_blank" rel="noopener">https://www.jianshu.com/p/45619cf50aa7</a></p>
<p><a href="https://docs.python.org/3/library/functions.html#super" target="_blank" rel="noopener">https://docs.python.org/3/library/functions.html#super</a></p>
<p><a href="https://en.wikipedia.org/wiki/C3_linearization" target="_blank" rel="noopener">https://en.wikipedia.org/wiki/C3_linearization</a></p>

        
      
    </div>

    

    

  </article>

    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2018/04/13/The-common-Flask-s-extensions/">Flask常见扩展总结</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2018-04-13
        </span>
        
          <div class="post-category">
            
              <a href="/categories/笔记/">笔记</a>
            
          </div>
        
        
      </div>
    </header>

    
    

    <div class="post-content">
      
        
        
          
        

        
          <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p><a href="http://flask.pocoo.org/" target="_blank" rel="noopener">Flask</a>是一个用python编写的、基于<a href="http://werkzeug.pocoo.org/" target="_blank" rel="noopener">Werkzeug WSGI</a>和<a href="http://jinja.pocoo.org/docs/2.10/" target="_blank" rel="noopener">Jinja2</a>的轻量级Web应用框架。因为其相比于django等框架来说简洁的功能与架构，常常被称为”microframework”。然而，称Flask为微框架并不意味着它相比起其它框架来说功能更少——Flask拥有强大的可扩展性以及活跃的社区。开发者可以根据自身的需求，自由的选择扩展包来增强其功能。</p>
<p>合理的选择扩展包，将极大的减少开发时间，提高开发效率。下面，本文就将列举出Flask应用程序开发中的一些常用扩展，以便于参考和查询。</p>
<h2 id="Flask-WTF"><a href="#Flask-WTF" class="headerlink" title="Flask-WTF"></a>Flask-WTF</h2><p>Flask-WTF将Flask和<a href="https://wtforms.readthedocs.io/en/stable/" target="_blank" rel="noopener">WTForms</a>做了简单集成，包含<a href="https://en.wikipedia.org/wiki/Cross-site_request_forgery" target="_blank" rel="noopener">CSRF</a>，文件上传，验证码服务等。</p>
<p>特点：</p>
<ol>
<li>集成WTForms</li>
<li>使用CSRF token保证安全性</li>
<li>全局CSRF防御</li>
<li>支持验证码服务</li>
<li>配合<a href="https://pythonhosted.org/Flask-Uploads/" target="_blank" rel="noopener">Flask-Uploads</a>运作的文件上传服务</li>
<li>使用<a href="http://pythonhosted.org/Flask-Babel/" target="_blank" rel="noopener">Flask-Babel</a>支持国际化</li>
</ol>
<p>Flask-WTF集成了WTForms，使用它，可以以面向对象语言中类的形式构建表单，简化了处理、验证表单所需操作，使表单设计与Flask其它部分统一。</p>
<p>文档：<a href="https://flask-wtf.readthedocs.io/en/stable/" target="_blank" rel="noopener">Flask-WTF</a></p>
<h2 id="Flask-SQLAlchemy"><a href="#Flask-SQLAlchemy" class="headerlink" title="Flask-SQLAlchemy"></a>Flask-SQLAlchemy</h2><p>Flask-SQLAlchemy为使用Flask开发的应用程序提供了<a href="http://www.sqlalchemy.org/" target="_blank" rel="noopener">SQLAlchemy</a>的支持。它支持0.8及以上版本的SQLAlchemy，旨在通过提供有用的默认值和额外的帮助来简化Flask中SQLAlchemy的使用，使完成常见的任务变得更简单。</p>
<p>SQLAlchemy为python提供了<a href="https://en.wikipedia.org/wiki/Orm" target="_blank" rel="noopener">ORM</a>(对象关系映射)。简单地说，ORM就是为操作不同数据库提供了一个用面向对象思想设计的统一上层接口，隐藏了在具体语言中真实操作、连接数据库的底层实现，从而解耦了应用和数据库，使得方便的更换数据库成为可能。（但同样，正因如此，ORM往往不能覆盖各数据库的特有功能）。通过Flask-SQLAlchemy，可以方便的在Flask使用SQLAlchemy。</p>
<p>文档：<a href="http://www.pythondoc.com/flask-sqlalchemy/" target="_blank" rel="noopener">Flask-SQLAlchemy</a></p>
<h2 id="Flask-MongoEngine"><a href="#Flask-MongoEngine" class="headerlink" title="Flask-MongoEngine"></a>Flask-MongoEngine</h2><p>Flask-MongoEngine集成了<a href="http://mongoengine.org/" target="_blank" rel="noopener">MongoEngine</a>。</p>
<p>通过它能够方便的在Flask中使用MongoDB。</p>
<p>文档：<a href="http://docs.mongoengine.org/projects/flask-mongoengine/en/latest/" target="_blank" rel="noopener">Flask-MongoEngine</a></p>
<h2 id="Flask-Login"><a href="#Flask-Login" class="headerlink" title="Flask-Login"></a>Flask-Login</h2><p>Flask-Login为Flask提供了用户会话管理。它能够处理如登陆、登出、持久记住用户会话等常见任务。</p>
<p>它将：</p>
<ol>
<li>将活动的用户ID储存在session中，让你能够方便的对他们进行登入登出操作。</li>
<li>让你能够限制视图只允许登入（或登出）用户访问。</li>
<li>处理常见的“记住我”功能。</li>
<li>保护你的用户会话以防被cookie小偷窃取。</li>
<li>之后可能会与Flask-Principal或其它验证扩展集成。</li>
</ol>
<p>然而，它不会：</p>
<ol>
<li>将特定的数据库或其它储存方法强加给你。用户如何载入，决定权完全在你的手中。</li>
<li>限制你使用如用户名和密码，OpenIDs，或其它验证方法。</li>
<li>处理超出“登入登出”之外的权限。</li>
<li>处理用户注册或账户重置。</li>
</ol>
<p>文档：<a href="https://flask-login.readthedocs.io/en/latest/" target="_blank" rel="noopener">Flask-Login</a></p>
<h2 id="Flask-Migrate"><a href="#Flask-Migrate" class="headerlink" title="Flask-Migrate"></a>Flask-Migrate</h2><p>Flask-Migrate是一个使用<a href="https://pypi.python.org/pypi/alembic" target="_blank" rel="noopener">Alembic</a>处理Flask应用程序中SQLAlchemy数据库迁移的扩展。数据库操作由Flask命令行接口或通过<a href="grate.readthedocs.io/en/latest/">Flask-Script</a>扩展而得到支持。</p>
<p>Flask中的SQLAlchemy只有在不存在这个表时才会按照程序中的定义新建一个表。然而，在开发过程中不免要更改表结构，此时就可以借助这个扩展来方便的更新数据库。</p>
<p>文档：<a href="https://flask-migrate.readthedocs.io/en/latest/" target="_blank" rel="noopener">Flask-Migrate</a></p>
<h2 id="Flask-RESTful"><a href="#Flask-RESTful" class="headerlink" title="Flask-RESTful"></a>Flask-RESTful</h2><p>Flask-RESTful是一个为Flask增加了快速绑定REST风格API功能的扩展。它是一个与你已经存在的ORM/库之间协同工作的轻量级抽象。Flask-RESTful鼓励使用最少设置的最佳实践。</p>
<p>文档:<a href="https://flask-restful.readthedocs.io/en/latest/" target="_blank" rel="noopener">Flask-RESTful</a></p>
<h2 id="Flask-Admin"><a href="#Flask-Admin" class="headerlink" title="Flask-Admin"></a>Flask-Admin</h2><p>Flask-Admin解决了在现有数据模型上构建管理界面的无聊问题。通过一定的努力，它能让你使用一个用户友好的界面管理web服务器数据。</p>
<p>文档：<a href="https://flask-admin.readthedocs.io/en/latest/" target="_blank" rel="noopener">Flask-Admin</a></p>
<h2 id="Flask-Bcrypt"><a href="#Flask-Bcrypt" class="headerlink" title="Flask-Bcrypt"></a>Flask-Bcrypt</h2><p>Flask-Bcrypt是一个为Flask应用程序提供了Bcrypt散列工具的Flask扩展。</p>
<p>Bcrypt是一种比MD5或SHA1稍慢，但更加安全、不易碰撞的散列算法。</p>
<p>文档：<a href="https://flask-bcrypt.readthedocs.io/en/latest/" target="_blank" rel="noopener">Flask-Bcrypt</a></p>
          <div class="read-more">
            <a href="/2018/04/13/The-common-Flask-s-extensions/" class="read-more-link">阅读更多</a>
          </div>
        
      
    </div>

    

    

  </article>

    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2018/03/05/扔鸡蛋问题/">扔鸡蛋问题</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2018-03-05
        </span>
        
          <div class="post-category">
            
              <a href="/categories/算法/">算法</a>
            
          </div>
        
        
      </div>
    </header>

    
    

    <div class="post-content">
      
        
        

        
          <p><img src="http://arian-blogs.oss-cn-beijing.aliyuncs.com/18-3-6/16293116.jpg" alt="sister"></p>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>逛知乎的时候偶然看到的一道算法问题，看了回答里大牛给的题解以后感觉解法十分巧妙，所以写一篇博客记载下来。<br>这个问题应该属于动态规划，但本人还没有怎么接触过算法这方面的知识，全属个人理解，所以文中可能有一些不标准的地方，还请见谅啦~，也欢迎指出来。</p>
<h2 id="题目简述"><a href="#题目简述" class="headerlink" title="题目简述"></a>题目简述</h2><p>有一栋200层高的大楼，给你两个质地相同但软硬未知的鸡蛋。如果在第n层扔下鸡蛋，鸡蛋不碎，那么，从第n-1层以下扔鸡蛋都不碎。如果要想测试出最高从第几层扔下时鸡蛋不会碎，问，在最坏情况下，所扔次数最少为多少？</p>
<h2 id="题目分析"><a href="#题目分析" class="headerlink" title="题目分析"></a>题目分析</h2><p>题目要求测试的是最高第几层扔下时不会碎，也就是说，在这一层下，鸡蛋都不会碎，在这一层上，鸡蛋都会碎。并且注意到，题目并没有规定这个层数，而是说在<strong>最坏</strong>的情况下所扔次数<strong>最少</strong>的策略。这也意味着，对于每个策略，鸡蛋可能在不同层数碎，并且总是使当前策略所需测试次数最多的那个层数。而我们所求的，就是在所有策略的最坏情况中，最少的那个次数。</p>
<h2 id="解题策略"><a href="#解题策略" class="headerlink" title="解题策略"></a>解题策略</h2><p>考虑如果只有一颗鸡蛋，那么就需要从第一层开始，逐一往上测试，直到找到破碎的那一层，这种策略最坏情况下所需次数为100.</p>
<h3 id="二分法"><a href="#二分法" class="headerlink" title="二分法"></a>二分法</h3><p>现在有两颗鸡蛋，那么就可以有一颗用来划定区间，另一颗用来测试鸡蛋将在这个区间的哪一层碎。比如，使用二分法，第一颗鸡蛋扔在50层。如果碎了，就用第二颗鸡蛋从第一层扔到第49层，直到在第49层破碎，那么一共测试了50次；如果鸡蛋不碎，就将第一颗鸡蛋扔在第75层，在根据碎不碎判断接下来的情况。</p>
<p>可以看出，使用二分法的情况下，最坏的次数需要50次。</p>
<h3 id="最优解"><a href="#最优解" class="headerlink" title="最优解"></a>最优解</h3><p>不妨假设在这种情况下用两颗鸡蛋测试z层，最少需要x次，考虑选择怎样的策略，才能在最坏的情况下，用这x次测试出最多的层数。</p>
<p>考虑第一次尝试应该选择扔在哪层楼。假设扔在第y层楼。如果第一颗鸡蛋在第y层楼破碎，那么，接下来需要用剩下来的那颗鸡蛋，最多需要用<code>y-1</code>次尝试测试最终鸡蛋在哪层楼破碎。在这种情况下，根据总是考虑最坏情况这个条件，如果<code>y&gt;x</code>，那最终就无法测试出鸡蛋是哪一层楼（因为最坏情况下鸡蛋在第<code>y-1</code>层楼，而只剩下<code>x-1</code>次尝试的次数）。所以第一次应该扔在<strong>小于等于</strong>x的楼层数。</p>
<p>考虑<code>y&lt;x</code>的情况。如果鸡蛋在第y层破碎，那么就可以用不到<code>x-1</code>的尝试次数测试出最终楼层；如果鸡蛋在第y层不破碎，那么，问题就转换为怎样用两颗鸡蛋，在<code>x-1</code>次的步骤内测试出<code>z-y</code>层楼里鸡蛋破碎位置的<strong>子问题</strong>。而这个子问题也和先前测试第一次尝试一样，第一颗扔出的鸡蛋不能大于<code>x-1</code>层，如果大于，次数就不够，必需扔在小于<code>x-1</code>次的楼层数。</p>
<p>这样，每一次不破碎，都生成一个新的独立的子问题。直到最终一颗鸡蛋在某一次测试中破碎，就用剩下的一颗鸡蛋逐一测试最近一次扔鸡蛋和破碎层之间的区间，找出正确答案。因为每一次不破碎都生成的都是<strong>独立</strong>的子问题（当前第一颗鸡蛋选择扔的层数不影响下一个子问题的决策），所以将每一次能测试出的最大的不破碎区间组合起来，就是最终能测试的最多层数。</p>
<p>因为每一次扔鸡蛋的最远距离就是当前次数的剩余数，所以需要每次测试，都扔在比当前层数大剩余次数的楼层。那么，如果有两颗鸡蛋，用x次尝试次数能确定的鸡蛋不破碎的最多层数就为<code>x+(x-1)+(x-2)...+1</code>。</p>
<p>回到原题来。原题要求求出用两颗鸡蛋测试200层楼所需的最少次数，也就是说需要<code>x+(x-1)+(x-2)...+1&gt;200</code>，也就是<code>x(x+1)/2&gt;200</code>，解出来就是x取整最少需要20次。</p>
<h2 id="程序语言"><a href="#程序语言" class="headerlink" title="程序语言"></a>程序语言</h2><p>以上是从推理方面来考察，现在从程序逻辑的方面考虑。</p>
<p>有200层楼，用两颗鸡蛋去测试使鸡蛋不碎的最高层数，要求求出最坏情况下的最小尝试次数。也就是，设初始选择扔在第y层，f(y)为在这种策略下的所需要的最多的次数，我们所求的为所有策略中最小的次数。如果第一颗鸡蛋在y层就破碎，那么所需要的次数就为y次，如果第一颗鸡蛋在y层不破碎，那么问题就转换为一个求用两颗鸡蛋测试200-y层所需要的最坏情况下的最少次数的子问题。</p>
<p>所以，状态转移方程就为：f(x)=min(max(i, f(i-1)+1))，(0&lt; i&lt;= x)。退出条件为i==0时，需要0次。</p>
<h2 id="程序实现"><a href="#程序实现" class="headerlink" title="程序实现"></a>程序实现</h2><p>使用了python实现，并且使用了functools库里面的lru_cache，这个装饰器会缓存函数结果，如果给函数传入了相同的参数，就直接返回缓存的结果。</p>
<p><em>以下这段代码参考自<a href="https://www.zhihu.com/question/19690210/answer/18079633" target="_blank" rel="noopener">吴育昕</a></em><br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> lru_cache</span><br><span class="line"></span><br><span class="line"><span class="meta">@lru_cache(maxsize=None)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test</span><span class="params">(m)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> m==<span class="number">0</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    res = min([max(i, test(m-i)+<span class="number">1</span>) <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,m+<span class="number">1</span>)])</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line">print(test(<span class="number">200</span>))</span><br><span class="line"><span class="comment">#结果：14</span></span><br></pre></td></tr></table></figure></p>
<h2 id="推广"><a href="#推广" class="headerlink" title="推广"></a>推广</h2><p>同理，如果推广到更一般的情况下，用n颗鸡蛋取测试m层的大楼，求最坏情况下的最少次数。首先选定一个楼层y，扔出第一颗鸡蛋。如果这颗鸡蛋破碎了，问题就转化为用n-1颗鸡蛋去测试m-1层楼的子问题；如果没碎，问题就转化为用n颗鸡蛋去测试m-y的子问题。</p>
<p>于是，在这种情况下的状态转移方程就为：f(m,n)=min(max(f(m-1,n-1), f(m-y,n)))+1，(0&lt; y&lt; m+1)。退出条件为当m==0时，需要0次；当n==1时，需要m次。</p>
<h3 id="推广情况程序实现"><a href="#推广情况程序实现" class="headerlink" title="推广情况程序实现"></a>推广情况程序实现</h3><p><em>以下这段代码参考自<a href="https://www.zhihu.com/question/19690210/answer/18079633" target="_blank" rel="noopener">吴育昕</a></em><br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> lru_cache</span><br><span class="line"></span><br><span class="line"><span class="meta">@lru_cache(maxsize=None)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test</span><span class="params">(n, m)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> m==<span class="number">0</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">    <span class="keyword">if</span> n==<span class="number">1</span>:</span><br><span class="line">        <span class="keyword">return</span> m</span><br><span class="line"></span><br><span class="line">    res = min([max(test(n<span class="number">-1</span>, i<span class="number">-1</span>), test(n, m-i)) <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,m+<span class="number">1</span>)])+<span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line">print(test(<span class="number">2</span>,<span class="number">36</span>))</span><br></pre></td></tr></table></figure></p>
<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><p><a href="">https://www.zhihu.com/question/19690210/answer/18079633</a><br><a href="">http://www.raychase.net/1374</a><br><a href="">http://blog.csdn.net/baolinq/article/details/53047288</a></p>

        
      
    </div>

    

    

  </article>

    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2018/03/03/新学期/">新学期开始</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2018-03-03
        </span>
        
          <div class="post-category">
            
              <a href="/categories/随笔/">随笔</a>
            
          </div>
        
        
      </div>
    </header>

    
    

    <div class="post-content">
      
        
        

        
          <blockquote>
<p>你永远不会知道，为了对生活感兴趣，我们究竟付出了多少努力。</p>
</blockquote>
<p>寒假偶然遇到一首很喜欢的音乐——雨降りお月さん（雨中的月亮），歌手为堀江由衣，是在补番过程中遇到的一首插曲。这首优美、朦胧，具有淡淡哀愁意境的歌在当时带给我十分深刻的印象。</p>
<iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width="330" height="86" src="//music.163.com/outchain/player?type=2&id=29091584&auto=0&height=66"></iframe>

<blockquote>
<p>雨降りお月さん （雨中的月亮，1925年）<br>作詞：野口雨情 作曲：中山晋平<br>歌词整理编译：九日旭（Guanxu）<br><br>雨降あめふりお月つきさん　雲くもの蔭かげ          雨中的月亮 躲在云背后<br>お嫁よめにゆくときゃ　誰だれとゆく      出嫁的时候 要和谁一起去<br>一人ひとりで傘からかさ　さして行ゆく          独自一人 撑伞前行<br>からかさないときゃ　誰だれとゆく    没有伞的话 又和谁一起呢<br>シャラシャラ　シャンシャン      叮叮当当<br>鈴すずつけた          铃声响   <br><br>お馬うまにゆられて　濡ぬれてゆく      在马上摇摇晃晃，冒雨前行<br>急いそがにゃお馬うまよ　夜よが明あけよう    马儿啊快些走 就要天亮了<br>手綱たづなの下したから ちょいと見みたりゃ   马儿从缰绳下面 瞄一下我<br>お袖そででお顔かほを　隠かくしてる          我用衣袖轻遮颜面<br>お袖そでは濡ぬれても　干ほしゃ乾かわく      衣袖湿了 晾晾就干<br>雨降あめふりお月つきさん　雲くもの蔭かげ          雨中的月亮 躲在云背后<br>お馬うまにゆられて　濡ぬれてゆく      在马上摇摇晃晃，冒雨前行<br><br>歌曲由两段原独立的两段歌词组成。第一段由野口雨情创作于大正14年（1925年）的儿童绘画杂志《コドモノクニ》一月号，并且刊登有相应杂志。后由作曲家中山晋平的建议改为歌曲，并受到大人孩子们的欢迎。为此，野口雨情以同一主题创作了一个续篇，以标题”雲の蔭“刊登在同年儿童绘画杂志《コドモノクニ》三月号上，同样配有装帧画并附带乐谱。在发售唱片时，因为原曲太短，两段词合起来作为一首歌。<br><br>歌曲描述了一位新娘子在骑马到婆家的雨路上的历程。配词充满童趣，同时引人幻想。然而，就如这隐隐约约透漏着哀愁、彷徨的旋律一样，这首歌具有这样的“黑色”背景：野口雨情的两个女儿都在年幼时夭折，而根据当地有这样的传说，如果新娘子是已经死去的女儿，那么她就会一个人独自启程去天国，而云背后（雲の蔭)的月亮正是隐喻中的天国。也许，这首歌正是野口雨情对其女儿亡灵的祝福。<br><br>参考自<a href="">http://blog.sina.com.cn/s/blog_4a4b274c0102wjwf.html</a></p>
</blockquote>
<p>除此之外，回过头来，整个寒假实在没有什么值得大肆回忆的内容。除了断断续续完成假期伊始订下的一些计划的日常（尽管到最后这些计划也没有来得及全部完成），就是一些琐碎的，在各种彷徨之中逝去的时间。旧的自己已经看起来渐渐消失，然而，新的自己尚没有来临，就是在这样的迷茫之中逝去的时间。</p>
<p>而新学期又要来临了。大学的第一个学期就这样完整的过去。到这里，也不再是可以以“新手”、“不适应”这样的话语来为自己找借口的时候了吧。</p>
<p>“给我振作起来啊，混蛋!”。希望新学期能够努力一点。</p>
<p><img src="http://arian-blogs.oss-cn-beijing.aliyuncs.com/18-3-3/20421160.jpg" alt="miku"><br>最后，为有miku的世界献上祝福。:p</p>

        
      
    </div>

    

    

  </article>

    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2018/02/04/南邮ctf训练平台Vigenere writeup/">南邮ctf训练平台Vigenere writeup</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2018-02-04
        </span>
        
          <div class="post-category">
            
              <a href="/categories/ctf/">ctf</a>
            
          </div>
        
        
      </div>
    </header>

    
    

    <div class="post-content">
      
        
        

        
          <blockquote>
<p>原题链接：<a href="">http://ctf.nuptsast.com/challenges#Vigenere</a></p>
</blockquote>
<h2 id="题目分析"><a href="#题目分析" class="headerlink" title="题目分析"></a>题目分析</h2><p>题目原文：</p>
<blockquote>
<p>It is said that Vigenere cipher does not achieve the perfect secrecy actually :-)<br>Tips:<br>1.The encode pragram is given;<br>2.Do u no index of coincidence ？<br>3.The key is last 6 words of the plain text(with “nctf{}” when submitted, also without any interpunction)</p>
</blockquote>
<p>加密代码：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"> <span class="meta">#<span class="meta-keyword">define</span> KEY_LENGTH 2 <span class="comment">// Can be anything from 1 to 13</span></span></span><br><span class="line"></span><br><span class="line">main()&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">char</span> ch;</span><br><span class="line">  FILE *fpIn, *fpOut;</span><br><span class="line">  <span class="keyword">int</span> i;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">char</span> key[KEY_LENGTH] = &#123;<span class="number">0x00</span>, <span class="number">0x00</span>&#125;;</span><br><span class="line">  <span class="comment">/* of course, I did not use the all-0s key to encrypt */</span></span><br><span class="line"></span><br><span class="line">  fpIn = fopen(<span class="string">"ptext.txt"</span>, <span class="string">"r"</span>);</span><br><span class="line">  fpOut = fopen(<span class="string">"ctext.txt"</span>, <span class="string">"w"</span>);</span><br><span class="line"></span><br><span class="line">  i=<span class="number">0</span>;</span><br><span class="line">  <span class="keyword">while</span> (<span class="built_in">fscanf</span>(fpIn, <span class="string">"%c"</span>, &amp;ch) != EOF) &#123;</span><br><span class="line">    <span class="comment">/* avoid encrypting newline characters */</span>  </span><br><span class="line">    <span class="comment">/* In a "real-world" implementation of the Vigenere cipher, </span></span><br><span class="line"><span class="comment">       every ASCII character in the plaintext would be encrypted.</span></span><br><span class="line"><span class="comment">       However, I want to avoid encrypting newlines here because </span></span><br><span class="line"><span class="comment">       it makes recovering the plaintext slightly more difficult... */</span></span><br><span class="line">    <span class="comment">/* ...and my goal is not to create "production-quality" code =) */</span></span><br><span class="line">    <span class="keyword">if</span> (ch!=<span class="string">'\n'</span>) &#123;</span><br><span class="line">      <span class="built_in">fprintf</span>(fpOut, <span class="string">"%02X"</span>, ch ^ key[i % KEY_LENGTH]); <span class="comment">// ^ is logical XOR    </span></span><br><span class="line">      i++;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">  fclose(fpIn);</span><br><span class="line">  fclose(fpOut);</span><br><span class="line">  <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>密文：<a href="">http://ctf.nuptsast.com/static/uploads/9a27a6c8b9fb7b8d2a07ad94924c02e5/code.txt</a></p>
<hr>
<p>可以看出，这道题的加密方式是维吉尼亚密码的变体。</p>
<p>原先的维吉尼亚加密，是指定一个密钥，然后将密钥循环与原文中每一个字母对应，这个字母偏移密钥在字母表中的序号后的新字母即为最终结果。如图：<br><img src="http://arian-blogs.oss-cn-beijing.aliyuncs.com/18-2-4/56426864.jpg" alt="维吉尼亚加密"></p>
<p>而这道题是用1到14个长度范围内，未知的密钥，一一，并且循环与明文异或，跳过换行符，将每一位异或的结果输出为两位16位数作为密文。与传统维吉尼亚偏移的加密方式相比，使用了异或的形式来加密原文。</p>
<h2 id="维吉尼亚密码回顾"><a href="#维吉尼亚密码回顾" class="headerlink" title="维吉尼亚密码回顾"></a>维吉尼亚密码回顾</h2><p>要解这道题，先回顾传统维吉尼亚密码的解密形式。</p>
<p>我们知道，与凯撒密码不同之处在于，维吉尼亚密码中，一个字母可能生成几个不同的密文，因此，不能像凯撒密码那样用轮转密文的方法来破解维吉尼亚密码。要破解维吉尼亚密码，首先要理解到，虽然维吉尼亚密码打乱了字母与密文一一对应的关系，但同一位密钥所对应的不同密文，却有着相同的偏移量。也就是说，如果知道了密钥的长度，那每一位密钥所加密的那一组密文就像是凯撒密码那样有<strong>相同的偏移量</strong>。</p>
<p>所以如果能找出密钥的长度，那我们就能将密文分隔成几组由不同偏移量凯撒加密所形成的密文。</p>
<p>又有，在自然英语中，各个字母的<strong>使用频率</strong>不同，即一些字母使用频率高些，另一些字母使用频率低些。比如说，字母e的使用频率最高，约0.12，字母z的使用频率最低，为0.00074。据此，就可以分别统计出前述几组密文中各字母的出现频率，在对比自然英语字母的使用频率，然后就能猜测每一位密文所对应的原文。根据一组密文拥有相同的偏移量这一点，就可猜测出最终的密钥。</p>
<p>因而，解密维吉尼亚密码的第一步在于找出密钥的长度。只要找出了密钥的长度，就可以统计字频猜测具体密钥。</p>
<p>怎样才能求出密钥的长度？这里引入十分重要的一点，也是求解维吉尼亚密码的关键，即<strong>重合指数</strong>（index of coincidence）。重合指数是指，在一串字母中，任意取出两个字母，这两个字母相同的概率。例如，随机给出一串混乱的字母，它的重合指数总会在0.45附近，而一串有意义的英语段落，因为字母使用频率的影响，重合指数总是会在0.65附近，并且段落越长越接近这两个值。</p>
<p>易见的是，给一串字母相同的偏移量，并不会改变这串字母的重合指数。因此，通过同一位密钥加密而成的那一组维吉尼亚密文，因为它是有意义的段落，它的重合指数应该接近于自然英语的重合指数0.68。根据这一点，就可以猜测密钥的长度，再计算各个长度下密钥的重合指数（每个长度下的几组可以取均值），结果最接近0.68的那个结果，就可以大胆猜测是密钥的长度。</p>
<p>求出了密钥的长度，就可以如上述那样通过字频统计求出每一位密钥进而解密出原文了。</p>
<h2 id="本题解法"><a href="#本题解法" class="headerlink" title="本题解法"></a>本题解法</h2><p>知道了传统维吉尼亚密码的解法，再看本题，也就不难了。虽然本题最终采用了异或的方式来加密原文，而不是传统维吉尼亚密码的偏移，但最终，只要能够求出密钥的长度，都可以使用字频分析的方法来计算出密钥来解密。</p>
<p>所以说，求解本题，主要也是首先确定密钥长度。</p>
<p>这里第一个思路就可以像以上求传统维吉尼亚密码那样通过计算重合指数来确定。然而有一点不可忽视的是，重合指数法只适合于给出的密文全部由字母加密而成的情况。传统维吉尼亚密码只能加密字母（偏移），这道题则通过异或的方法来加密，使得任意字符都可以生成对应的密文。因此，由于其它非字母字符的干扰，就无法求出准确的重合指数，也就难以通过重合指数法寻找出密钥长度。</p>
<p>注意到，本题使用的是异或形式来加密。是否还记得异或有几个独特性质：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">a^a = 0         //一个数异或本身等于零</span><br><span class="line">a^0 = a         //一个数异或零等于本身</span><br><span class="line">(a^b)^c = a^(b^c)       //异或满足结合律</span><br><span class="line">a^b^b = a       //因此，一个数两次异或同一个数等于本身</span><br></pre></td></tr></table></figure></p>
<p>本题的密文是由明文与密钥异或而来的，因此 <code>明文^密钥 = 密文</code>，也就是<code>明文 = 密文^密钥</code>。关键点是，<strong>明文一定是由ascii字符组成的，并且密钥一定存在</strong>。如果假定出密钥的长度，那么可以将密文划分成相应的几组，密钥的取值范围又在一定的范围之内（unsigned char ，0~255）。因此，如果在假定的长度下，某一组密文在这个范围内找不到合理的密钥（使得与密文异或为ascii字符的密钥），那就说明密钥不可能是这个长度。</p>
<p>通过这种方式，就可以求得密钥可能的长度范围的取值，并且还可以求出这个长度下，各组密文对应密钥的可能值（使得这组密文全部能求得ascii范围内的明文的所有可能取值）。</p>
<p>求出了密钥的长度，以及每一位密钥的可能取值，再测试出每一位密钥可能取值解出原文对应的字频，取其中最符合自然英语的那一个，就可以猜测这是最终的密钥了。</p>
<h2 id="具体实现"><a href="#具体实现" class="headerlink" title="具体实现"></a>具体实现</h2><p>首先，求出1~14范围内密钥的取值，如果有空集就证明不能为这个长度：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">controlFlow</span><span class="params">()</span>:</span></span><br><span class="line">    keyLengthRange = range(<span class="number">1</span>,<span class="number">15</span>)</span><br><span class="line">    cipher = readCipher(<span class="string">'c.txt'</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> keyLengthRange:</span><br><span class="line">        keyGroup = getKeyRange(i, cipher)</span><br><span class="line">        <span class="keyword">for</span> a <span class="keyword">in</span> keyGroup:</span><br><span class="line">            <span class="keyword">if</span> <span class="number">0</span> == len(a):</span><br><span class="line">                <span class="keyword">break</span>;          <span class="comment">#密钥每一位一定有值</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment">#没有空集就通过字频求具体值</span></span><br><span class="line">            ......      <span class="comment">#省略的代码</span></span><br></pre></td></tr></table></figure></p>
<p>其中，getKeyRange求出每一位密钥的可能值：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getKeyRange</span><span class="params">(keyLength, cipher)</span>:</span></span><br><span class="line">    <span class="string">'''</span></span><br><span class="line"><span class="string">    测试每一位密钥可能的取值，若生成范围之外的明文，就抛弃这个值</span></span><br><span class="line"><span class="string">    否则，就将这个值加入结果集之中</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line">    cipherGroup = getCipherGroup(keyLength, cipher)</span><br><span class="line">    keyGroup = [[] <span class="keyword">for</span> a <span class="keyword">in</span> range(keyLength)]</span><br><span class="line"></span><br><span class="line">    count=<span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> perCipherGroup <span class="keyword">in</span> cipherGroup:</span><br><span class="line">        <span class="keyword">for</span> keyTest <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">255</span>):</span><br><span class="line">            <span class="keyword">for</span> perCipher <span class="keyword">in</span> perCipherGroup:</span><br><span class="line">                plainChar = perCipher^keyTest</span><br><span class="line">                <span class="keyword">if</span> plainChar <span class="keyword">not</span> <span class="keyword">in</span> range(<span class="number">32</span>,<span class="number">127</span>):</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                keyGroup[count].append(keyTest)</span><br><span class="line">        count+=<span class="number">1</span>        <span class="comment">#下一组密文</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> keyGroup</span><br></pre></td></tr></table></figure></p>
<p>求出密钥范围，就通过字频统计求出具体值：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getLetterFrequency</span><span class="params">(key, perCipher)</span>:</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">求出综合字频</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line">    frequencies = &#123;<span class="string">"e"</span>: <span class="number">0.12702</span>, <span class="string">"t"</span>: <span class="number">0.09056</span>, <span class="string">"a"</span>: <span class="number">0.08167</span>, <span class="string">"o"</span>: <span class="number">0.07507</span>, <span class="string">"i"</span>: <span class="number">0.06966</span>,</span><br><span class="line">                   <span class="string">"n"</span>: <span class="number">0.06749</span>, <span class="string">"s"</span>: <span class="number">0.06327</span>, <span class="string">"h"</span>: <span class="number">0.06094</span>, <span class="string">"r"</span>: <span class="number">0.05987</span>, <span class="string">"d"</span>: <span class="number">0.04253</span>,</span><br><span class="line">                   <span class="string">"l"</span>: <span class="number">0.04025</span>, <span class="string">"c"</span>: <span class="number">0.02782</span>, <span class="string">"u"</span>: <span class="number">0.02758</span>, <span class="string">"m"</span>: <span class="number">0.02406</span>, <span class="string">"w"</span>: <span class="number">0.02360</span>,</span><br><span class="line">                   <span class="string">"f"</span>: <span class="number">0.02228</span>, <span class="string">"g"</span>: <span class="number">0.02015</span>, <span class="string">"y"</span>: <span class="number">0.01974</span>, <span class="string">"p"</span>: <span class="number">0.01929</span>, <span class="string">"b"</span>: <span class="number">0.01492</span>,</span><br><span class="line">                   <span class="string">"v"</span>: <span class="number">0.00978</span>, <span class="string">"k"</span>: <span class="number">0.00772</span>, <span class="string">"j"</span>: <span class="number">0.00153</span>, <span class="string">"x"</span>: <span class="number">0.00150</span>, <span class="string">"q"</span>: <span class="number">0.00095</span>,</span><br><span class="line">                   <span class="string">"z"</span>: <span class="number">0.00074</span>&#125;        <span class="comment">#各个字母的出现频率</span></span><br><span class="line"></span><br><span class="line">    count=&#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> ch <span class="keyword">in</span> perCipher:</span><br><span class="line">        plainChar = key^ch</span><br><span class="line">        <span class="keyword">if</span> plainChar <span class="keyword">in</span> range(<span class="number">65</span>,<span class="number">91</span>) <span class="keyword">or</span> plainChar <span class="keyword">in</span> range(<span class="number">97</span>,<span class="number">123</span>):         <span class="comment">#要排除非字母字符</span></span><br><span class="line">            char = chr(plainChar).lower()</span><br><span class="line">            count[char] = count.setdefault(char, <span class="number">0</span>)+<span class="number">1</span>         <span class="comment">#这个字母出现的次数</span></span><br><span class="line"></span><br><span class="line">    freq = <span class="number">0.0</span></span><br><span class="line">    <span class="keyword">for</span> a <span class="keyword">in</span> count:</span><br><span class="line">        freq += frequencies[a]*count[a]/len(perCipher)          <span class="comment">#除以密文长度，以尽可能减小非字母字符对字频的影响</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> freq</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getKeyConfirmValue</span><span class="params">(keyGroup,cipher)</span>:</span></span><br><span class="line">    <span class="string">'''</span></span><br><span class="line"><span class="string">    计算假定某一位上的密钥是正确的情况下，用这个密钥解密密文所出来的明文段落中字母的综合使用频率，正确的密钥这个频率应该尽可能高</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line">    cipherGroup = getCipherGroup(len(keyGroup), cipher)</span><br><span class="line">    key = []</span><br><span class="line"></span><br><span class="line">    count=<span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> perKey <span class="keyword">in</span> keyGroup:</span><br><span class="line">        maxFreq = <span class="number">0</span></span><br><span class="line">        tempKey = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> a <span class="keyword">in</span> perKey:</span><br><span class="line">            freq = getLetterFrequency(a, cipherGroup[count])</span><br><span class="line">            <span class="keyword">if</span> freq&gt;maxFreq:            <span class="comment">#正确的密钥，算出来的综合字频应该尽可能大</span></span><br><span class="line">                maxFreq = freq</span><br><span class="line">                tempKey = a</span><br><span class="line">        key.append(tempKey)</span><br><span class="line">        count += <span class="number">1</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> key</span><br></pre></td></tr></table></figure></p>
<p>最后解密出原文：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cipherDecrypt</span><span class="params">(key, cipher)</span>:</span></span><br><span class="line">    plainText = <span class="string">''</span></span><br><span class="line">    index = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> a <span class="keyword">in</span> cipher:</span><br><span class="line">        plainText += chr(key[index%len(key)]^a)</span><br><span class="line">        index += <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> plainText</span><br></pre></td></tr></table></figure></p>
<p>最终得出的结果为：</p>
<blockquote>
<p>A possible key is: [186, 31, 145, 178, 83, 205, 62] </p>
<p>A possible plainText is: Cryptography is the practice and study of techniques for, among other things, secure communication in the presence of attackers. Cryptography has been used for hundreds, if not thousands, of years, but traditional cryptosystems were designed and evaluated in a fairly ad hoc manner. For example, the Vigenere encryption scheme was thought to be secure for decades after it was invented, but we now know, and this exercise demonstrates, that it can be broken very easily. </p>
</blockquote>
<p>题目中说falg是原文最后六个字母，没有标点，因此最终得到的falg为：</p>
<blockquote>
<p>nctf{it can be broken very easily}          </p>
</blockquote>
<p>对我一点也不简单就是了…</p>
<h2 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h2><p>觉得很有意义的一道题，通过这道题学习了许多知识点，所以写成了博客。希望文中不对的地方能够被大家指正:)。</p>
<hr>
<p><em><del>看了两篇writeup才能做出来什么的…。</del></em></p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="">https://findneo.github.io/2017/10/nupt-vigenere/</a><br><a href="">http://blog.csdn.net/qq_31344951/article/details/77934717</a><br><a href="">https://zh.wikipedia.org/wiki/%E7%BB%B4%E5%90%89%E5%B0%BC%E4%BA%9A%E5%AF%86%E7%A0%81</a><br><a href="">https://www.zhihu.com/question/29515338</a><br><a href="">http://blog.csdn.net/limisky/article/details/16885959</a></p>
<!--read more-->
<h2 id="完整代码"><a href="#完整代码" class="headerlink" title="完整代码"></a>完整代码</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">readCipher</span><span class="params">(filename)</span>:</span></span><br><span class="line">    file = open(filename, <span class="string">'r'</span>)</span><br><span class="line">    strCipher = file.read()</span><br><span class="line">    cipher = []</span><br><span class="line">    index = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> index &lt; len(strCipher):</span><br><span class="line">        cipher.append(int(strCipher[index:index+<span class="number">2</span>], <span class="number">16</span>))</span><br><span class="line">        index += <span class="number">2</span></span><br><span class="line">    <span class="keyword">return</span> cipher</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getCipherGroup</span><span class="params">(keyLength, cipher)</span>:</span></span><br><span class="line">    cipherGroup = [[] <span class="keyword">for</span> a <span class="keyword">in</span> range(keyLength)]</span><br><span class="line">    count = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> count &lt; len(cipher):</span><br><span class="line">        cipherGroup[(count) % keyLength] += [cipher[count]]</span><br><span class="line">        count += <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> cipherGroup</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getKeyRange</span><span class="params">(keyLength, cipher)</span>:</span></span><br><span class="line">    cipherGroup = getCipherGroup(keyLength, cipher)</span><br><span class="line">    keyGroup = [[] <span class="keyword">for</span> a <span class="keyword">in</span> range(keyLength)]</span><br><span class="line"></span><br><span class="line">    count=<span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> perCipherGroup <span class="keyword">in</span> cipherGroup:</span><br><span class="line">        <span class="keyword">for</span> keyTest <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">255</span>):</span><br><span class="line">            <span class="keyword">for</span> perCipher <span class="keyword">in</span> perCipherGroup:</span><br><span class="line">                plainChar = perCipher^keyTest</span><br><span class="line">                <span class="keyword">if</span> plainChar <span class="keyword">not</span> <span class="keyword">in</span> range(<span class="number">32</span>,<span class="number">127</span>):</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                keyGroup[count].append(keyTest)</span><br><span class="line">        count+=<span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> keyGroup</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getLetterFrequency</span><span class="params">(key, perCipher)</span>:</span></span><br><span class="line">    frequencies = &#123;<span class="string">"e"</span>: <span class="number">0.12702</span>, <span class="string">"t"</span>: <span class="number">0.09056</span>, <span class="string">"a"</span>: <span class="number">0.08167</span>, <span class="string">"o"</span>: <span class="number">0.07507</span>, <span class="string">"i"</span>: <span class="number">0.06966</span>,</span><br><span class="line">                   <span class="string">"n"</span>: <span class="number">0.06749</span>, <span class="string">"s"</span>: <span class="number">0.06327</span>, <span class="string">"h"</span>: <span class="number">0.06094</span>, <span class="string">"r"</span>: <span class="number">0.05987</span>, <span class="string">"d"</span>: <span class="number">0.04253</span>,</span><br><span class="line">                   <span class="string">"l"</span>: <span class="number">0.04025</span>, <span class="string">"c"</span>: <span class="number">0.02782</span>, <span class="string">"u"</span>: <span class="number">0.02758</span>, <span class="string">"m"</span>: <span class="number">0.02406</span>, <span class="string">"w"</span>: <span class="number">0.02360</span>,</span><br><span class="line">                   <span class="string">"f"</span>: <span class="number">0.02228</span>, <span class="string">"g"</span>: <span class="number">0.02015</span>, <span class="string">"y"</span>: <span class="number">0.01974</span>, <span class="string">"p"</span>: <span class="number">0.01929</span>, <span class="string">"b"</span>: <span class="number">0.01492</span>,</span><br><span class="line">                   <span class="string">"v"</span>: <span class="number">0.00978</span>, <span class="string">"k"</span>: <span class="number">0.00772</span>, <span class="string">"j"</span>: <span class="number">0.00153</span>, <span class="string">"x"</span>: <span class="number">0.00150</span>, <span class="string">"q"</span>: <span class="number">0.00095</span>,</span><br><span class="line">                   <span class="string">"z"</span>: <span class="number">0.00074</span>&#125;</span><br><span class="line"></span><br><span class="line">    count=&#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> ch <span class="keyword">in</span> perCipher:</span><br><span class="line">        plainChar = key^ch</span><br><span class="line">        <span class="keyword">if</span> plainChar <span class="keyword">in</span> range(<span class="number">65</span>,<span class="number">91</span>) <span class="keyword">or</span> plainChar <span class="keyword">in</span> range(<span class="number">97</span>,<span class="number">123</span>):</span><br><span class="line">            char = chr(plainChar).lower()</span><br><span class="line">            count[char] = count.setdefault(char, <span class="number">0</span>)+<span class="number">1</span></span><br><span class="line"></span><br><span class="line">    freq = <span class="number">0.0</span></span><br><span class="line">    <span class="keyword">for</span> a <span class="keyword">in</span> count:</span><br><span class="line">        freq += frequencies[a]*count[a]/len(perCipher)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> freq</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getKeyConfirmValue</span><span class="params">(keyGroup,cipher)</span>:</span></span><br><span class="line">    cipherGroup = getCipherGroup(len(keyGroup), cipher)</span><br><span class="line">    key = []</span><br><span class="line"></span><br><span class="line">    count=<span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> perKey <span class="keyword">in</span> keyGroup:</span><br><span class="line">        maxFreq = <span class="number">0</span></span><br><span class="line">        tempKey = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> a <span class="keyword">in</span> perKey:</span><br><span class="line">            freq = getLetterFrequency(a, cipherGroup[count])</span><br><span class="line">            <span class="keyword">if</span> freq&gt;maxFreq:</span><br><span class="line">                maxFreq = freq</span><br><span class="line">                tempKey = a</span><br><span class="line">        key.append(tempKey)</span><br><span class="line">        count += <span class="number">1</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> key</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cipherDecrypt</span><span class="params">(key, cipher)</span>:</span></span><br><span class="line">    plainText = <span class="string">''</span></span><br><span class="line">    index = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> a <span class="keyword">in</span> cipher:</span><br><span class="line">        plainText += chr(key[index%len(key)]^a)</span><br><span class="line">        index += <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> plainText</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">controlFlow</span><span class="params">()</span>:</span></span><br><span class="line">    keyLengthRange = range(<span class="number">1</span>,<span class="number">15</span>)</span><br><span class="line">    cipher = readCipher(<span class="string">'c.txt'</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> keyLengthRange:</span><br><span class="line">        keyGroup = getKeyRange(i, cipher)</span><br><span class="line">        <span class="keyword">for</span> a <span class="keyword">in</span> keyGroup:</span><br><span class="line">            <span class="keyword">if</span> <span class="number">0</span> == len(a):</span><br><span class="line">                <span class="keyword">break</span>;          </span><br><span class="line">        <span class="keyword">else</span>:               </span><br><span class="line">            <span class="comment">#print('A possible key group is:', keyGroup,'\n')</span></span><br><span class="line">            key = getKeyConfirmValue(keyGroup, cipher)</span><br><span class="line">            print(<span class="string">'A possible key is:'</span>, key,<span class="string">'\n'</span>)</span><br><span class="line">            plainText = cipherDecrypt(key, cipher)</span><br><span class="line">            print(<span class="string">'A possible plainText is:'</span>, plainText,<span class="string">'\n'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">'__main__'</span>:</span><br><span class="line">    controlFlow()</span><br></pre></td></tr></table></figure>

        
      
    </div>

    

    

  </article>

    
  </section>

  
  <nav class="pagination">
    
    
  </nav>


          </div>
          

        </div>
      </main>

      <footer id="footer" class="footer">

  <div class="social-links">
    
      
        
          <a href="mailto:ysnyyhs@163.com" class="iconfont icon-email" title="email"></a>
        
      
    
      
    
      
    
      
    
      
    
      
    
      
        
          <a href="https://github.com/Arianxx" class="iconfont icon-github" title="github"></a>
        
      
    
      
    
      
    
      
        
          <a href="https://www.douban.com/people/131732783/" class="iconfont icon-douban" title="douban"></a>
        
      
    
      
    
      
    
      
    
    
    
      <a href="/atom.xml" class="iconfont icon-rss" title="rss"></a>
    
  </div>


<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://hexo.io/">Hexo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/ahonn/hexo-theme-even">Even</a>
  </span>

  <span class="copyright-year">
    
    &copy; 
     
      2017 - 
    
    2018

    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">Arian</span>
  </span>
</div>

      </footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div>

    


    




  
    <script type="text/javascript" src="/lib/jquery/jquery-3.1.1.min.js"></script>
  

  
    <script type="text/javascript" src="/lib/slideout/slideout.js"></script>
  

  


    <script type="text/javascript" src="/js/src/even.js?v=2.6.0"></script>
<script type="text/javascript" src="/js/src/bootstrap.js?v=2.6.0"></script>

  <script src="/live2dw/lib/L2Dwidget.min.js?0c58a1486de42ac6cc1c59c7d98ae887"></script><script>L2Dwidget.init({"model":{"scale":1,"hHeadPos":0.5,"vHeadPos":0.618,"jsonPath":"/live2dw/assets/model.model.json"},"display":{"superSample":2,"width":120,"height":240,"position":"left","hOffset":0,"vOffset":-165},"mobile":{"show":false,"scale":0.5},"react":{"opacityDefault":1,"opacityOnhover":1},"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/"});</script></body>
</html>
